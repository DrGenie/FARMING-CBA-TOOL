<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Farming CBA Decision Tool 2 — control-centric cost–benefit analysis with Excel-first workflow." />
    <title>Farming CBA Decision Tool 2</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <header class="app-header">
      <div class="header-inner">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">NBS</div>
          <div class="brand-text">
            <div class="kicker">Newcastle Business School</div>
            <h1 id="appTitle">Farming CBA Decision Tool 2</h1>
            <div class="subkicker">Control-centric results • Excel-first workflow • Export-ready outputs</div>
          </div>
        </div>

        <div class="header-actions">
          <button class="btn ghost" id="exportProjectJsonBtn" type="button" title="Download a JSON snapshot of the full project state">
            Export project JSON
          </button>
          <button class="btn ghost" id="exportPdfBtn" type="button" title="Print or save to PDF">
            Print / Save as PDF
          </button>
        </div>
      </div>

      <nav class="tabs" aria-label="Tool sections">
        <button class="tab active" data-tab-target="results" type="button" aria-selected="true">Results</button>
        <button class="tab" data-tab-target="data" type="button" aria-selected="false">Data import</button>
        <button class="tab" data-tab-target="introduction" type="button" aria-selected="false">Introduction</button>
        <button class="tab" data-tab-target="basics" type="button" aria-selected="false">Project & settings</button>
        <button class="tab" data-tab-target="outputs" type="button" aria-selected="false">Outputs</button>
        <button class="tab" data-tab-target="treatments" type="button" aria-selected="false">Treatments</button>
        <button class="tab" data-tab-target="benefits" type="button" aria-selected="false">Additional benefits</button>
        <button class="tab" data-tab-target="costs" type="button" aria-selected="false">Other costs</button>
        <button class="tab" data-tab-target="simulations" type="button" aria-selected="false">Simulations</button>
        <button class="tab" data-tab-target="ai" type="button" aria-selected="false">Copilot / AI</button>
      </nav>
    </header>

    <main id="main" class="app-main">
      <!-- =========================
           RESULTS (DEFAULT LANDING)
           ========================= -->
      <section class="tab-panel active" data-tab-panel="results" id="tab-results" aria-hidden="false">
        <div class="panel-head">
          <div>
            <h2>Results</h2>
            <p class="muted">
              The default landing view is a control-centric comparison. Control (baseline) is shown alongside every treatment.
            </p>
          </div>
          <div class="pill-row">
            <span class="pill">Sticky table headers</span>
            <span class="pill">Horizontal scroll for many treatments</span>
            <span class="pill">Excel and CSV export</span>
          </div>
        </div>

        <section class="cards">
          <div class="card">
            <div class="card-title">PV Benefits</div>
            <div class="value" id="pvBenefits">$0</div>
            <div class="card-note muted">Discounted value of benefits over the period.</div>
          </div>

          <div class="card">
            <div class="card-title">PV Costs</div>
            <div class="value" id="pvCosts">$0</div>
            <div class="card-note muted">Capital is year 0; annual costs are discounted.</div>
          </div>

          <div class="card">
            <div class="card-title">NPV</div>
            <div class="value positive" id="npv">$0</div>
            <div class="card-note muted">PV Benefits − PV Costs.</div>
          </div>

          <div class="card">
            <div class="card-title">BCR</div>
            <div class="value" id="bcr">n/a</div>
            <div class="card-note muted">PV Benefits ÷ PV Costs.</div>
          </div>

          <div class="card">
            <div class="card-title">ROI</div>
            <div class="value" id="roi">n/a</div>
            <div class="card-note muted">NPV ÷ PV Costs (%).</div>
          </div>

          <div class="card">
            <div class="card-title">Payback</div>
            <div class="value" id="payback">Not reached</div>
            <div class="card-note muted">Discounted payback (years).</div>
          </div>
        </section>

        <section class="grid-2">
          <div class="panel">
            <div class="panel-title-row">
              <h3>Snapshot leaderboard</h3>
              <div class="muted small">Quick view: rank, NPV, BCR and deltas vs control.</div>
            </div>
            <div id="leaderboard" class="panel-body">
              <div class="skeleton">
                <div class="skeleton-bar"></div>
                <div class="skeleton-bar"></div>
                <div class="skeleton-bar"></div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-title-row">
              <h3>Validation summary</h3>
              <div class="muted small">Loaded Excel sheet, missing values, and formula detection.</div>
            </div>
            <div id="validationPanel" class="panel-body"></div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-title-row">
            <h3>Comparison to Control</h3>
            <div class="muted small">Rows = indicators; columns = Control + treatments with Δ vs Control.</div>
          </div>
          <div id="comparisonTable" class="panel-body">
            <div class="skeleton">
              <div class="skeleton-bar"></div>
              <div class="skeleton-bar"></div>
              <div class="skeleton-bar"></div>
              <div class="skeleton-bar"></div>
            </div>
          </div>
        </section>

        <section class="grid-2">
          <div class="panel">
            <div class="panel-title-row">
              <h3>Time horizon check</h3>
              <div class="muted small">PV and NPV at common horizons (based on base case settings).</div>
            </div>

            <div class="panel-body">
              <div class="table-wrap compact">
                <table class="table" id="timeProjectionTable">
                  <thead>
                    <tr>
                      <th>Years</th>
                      <th>PV Benefits</th>
                      <th>PV Costs</th>
                      <th>NPV</th>
                      <th>BCR</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <div class="chart-card">
                <div class="muted small">NPV by horizon</div>
                <canvas id="timeNpvChart" width="720" height="260" aria-label="NPV by horizon chart"></canvas>
              </div>

              <div class="inline-stats">
                <div class="stat">
                  <div class="muted small">IRR</div>
                  <div id="irr" class="stat-val">n/a</div>
                </div>
                <div class="stat">
                  <div class="muted small">MIRR</div>
                  <div id="mirr" class="stat-val">n/a</div>
                </div>
                <div class="stat">
                  <div class="muted small">Gross margin (annual)</div>
                  <div id="grossMargin" class="stat-val">$0</div>
                </div>
                <div class="stat">
                  <div class="muted small">Profit margin</div>
                  <div id="profitMargin" class="stat-val">n/a</div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-title-row">
              <h3>Depreciation summary</h3>
              <div class="muted small">Only shown when depreciation is configured for capital items.</div>
            </div>
            <div class="panel-body" id="depSummary"></div>
          </div>
        </section>
      </section>

      <!-- =========================
           DATA IMPORT
           ========================= -->
      <section class="tab-panel" data-tab-panel="data" id="tab-data" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Data import</h2>
            <p class="muted">
              Upload your Excel file and the tool will parse, validate, and recalibrate using the same pipeline as the default dataset.
            </p>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body">
            <div class="callout">
              <strong>Excel-first workflow.</strong>
              Download the template, edit the <code>FabaBeanRaw</code> sheet, then upload it back here.
              Use <code>?</code> for unknown values (treated as missing, never zero).
            </div>

            <div class="row-6">
              <div class="field">
                <label>Upload Excel (.xlsx)</label>
                <input id="excelUpload" type="file" accept=".xlsx,.xls" />
                <div class="help">Expected sheet name: <code>FabaBeanRaw</code> (variants accepted).</div>
              </div>

              <div class="field">
                <label>&nbsp;</label>
                <button id="uploadExcelBtn" class="btn primary" type="button">Upload and apply</button>
                <div class="help">Parses and validates using the Excel pipeline.</div>
              </div>

              <div class="field">
                <label>&nbsp;</label>
                <button id="downloadTemplateBtn" class="btn ghost" type="button">Download Excel template</button>
                <div class="help">Template mirrors the embedded default dataset.</div>
              </div>

              <div class="field">
                <label>&nbsp;</label>
                <button id="downloadCurrentBtn" class="btn ghost" type="button">Download current dataset workbook</button>
                <div class="help">Exports the preserved raw rows currently loaded.</div>
              </div>

              <div class="field">
                <label>&nbsp;</label>
                <button id="reloadDefaultBtn" class="btn" type="button">Reload default dataset</button>
                <div class="help">Rebuilds the default workbook and re-runs the same pipeline.</div>
              </div>

              <div class="field">
                <label>&nbsp;</label>
                <button class="btn ghost" data-tab-jump="results" type="button">Go to Results</button>
                <div class="help">Opens the comparison-to-control table.</div>
              </div>
            </div>

            <div class="spacer"></div>

            <div class="panel slim">
              <div class="panel-title-row">
                <h3>Validation details</h3>
                <div class="muted small">If you see errors, fix the Excel sheet and upload again.</div>
              </div>
              <div class="panel-body" id="validationPanelDataMirror"></div>
            </div>
          </div>
        </section>
      </section>

      <!-- =========================
           INTRODUCTION
           ========================= -->
      <section class="tab-panel" data-tab-panel="introduction" id="tab-introduction" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Introduction</h2>
            <p class="muted">
              This tool summarises costs and benefits over time and compares treatments against a single control baseline.
              Edit assumptions and inputs to explore trade-offs and sensitivities.
            </p>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body prose">
            <h3>How to read the Results tab</h3>
            <p>
              The main table is a “Comparison to Control” view. Each indicator is a row. The first value column is the
              control baseline. For every treatment, the table shows the treatment value, the absolute difference versus
              control, and where meaningful, the percentage difference.
            </p>
            <h3>Missing values</h3>
            <p>
              If the Excel file contains blanks or <code>?</code>, the tool treats those cells as missing and flags them
              in validation. Missing values are not forced to zero. Where a missing input would otherwise break a calculation,
              the tool keeps computations stable but reports the missingness in the validation panel.
            </p>
            <h3>Exports</h3>
            <p>
              The comparison table can be exported directly to Excel for reporting and copy-paste into Word. Use
              Print/Save as PDF for a clean printable view.
            </p>
          </div>
        </section>
      </section>

      <!-- =========================
           PROJECT & SETTINGS
           ========================= -->
      <section class="tab-panel" data-tab-panel="basics" id="tab-basics" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Project & settings</h2>
            <p class="muted">Project metadata, timeline, discounting, adoption, risk and simulation settings.</p>
          </div>
        </div>

        <section class="panel">
          <div class="panel-title-row">
            <h3>Project details</h3>
            <div class="muted small">Used in exports and documentation.</div>
          </div>
          <div class="panel-body">
            <div class="row-6">
              <div class="field"><label>Project name</label><input id="projectName" /></div>
              <div class="field"><label>Project lead</label><input id="projectLead" /></div>
              <div class="field"><label>Analysts</label><input id="analystNames" /></div>
              <div class="field"><label>Team</label><input id="projectTeam" /></div>
              <div class="field"><label>Organisation</label><input id="organisation" /></div>
              <div class="field"><label>Last updated</label><input id="lastUpdated" type="date" /></div>
            </div>

            <div class="field">
              <label>Summary</label>
              <textarea id="projectSummary" rows="3"></textarea>
            </div>

            <div class="row-2">
              <div class="field">
                <label>Objectives</label>
                <textarea id="projectObjectives" rows="3"></textarea>
              </div>
              <div class="field">
                <label>Activities</label>
                <textarea id="projectActivities" rows="3"></textarea>
              </div>
            </div>

            <div class="row-2">
              <div class="field">
                <label>Stakeholders</label>
                <textarea id="stakeholderGroups" rows="2"></textarea>
              </div>
              <div class="field">
                <label>Contact (email / phone)</label>
                <div class="row-2">
                  <input id="contactEmail" placeholder="email" />
                  <input id="contactPhone" placeholder="phone" />
                </div>
              </div>
            </div>

            <div class="row-2">
              <div class="field">
                <label>Goal</label>
                <textarea id="projectGoal" rows="2"></textarea>
              </div>
              <div class="field">
                <label>With / without project</label>
                <div class="row-2">
                  <textarea id="withProject" rows="2" placeholder="With project"></textarea>
                  <textarea id="withoutProject" rows="2" placeholder="Without project"></textarea>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="grid-2">
          <div class="panel">
            <div class="panel-title-row">
              <h3>Timeline & discounting</h3>
              <div class="muted small">Base-case discount rate drives PV calculations and the comparison table.</div>
            </div>
            <div class="panel-body">
              <div class="row-6">
                <div class="field"><label>Start year</label><input id="startYear" type="number" /></div>
                <div class="field"><label>Project start year</label><input id="projectStartYear" type="number" /></div>
                <div class="field"><label>Years</label><input id="years" type="number" min="1" step="1" /></div>
                <div class="field"><label>Discount (base, %)</label><input id="discBase" type="number" step="0.1" /></div>
                <div class="field"><label>Discount (low, %)</label><input id="discLow" type="number" step="0.1" /></div>
                <div class="field"><label>Discount (high, %)</label><input id="discHigh" type="number" step="0.1" /></div>
              </div>

              <div class="row-6">
                <div class="field"><label>MIRR finance rate (%)</label><input id="mirrFinance" type="number" step="0.1" /></div>
                <div class="field"><label>MIRR reinvest rate (%)</label><input id="mirrReinvest" type="number" step="0.1" /></div>
                <div class="field"><label>System type</label>
                  <select id="systemType">
                    <option value="single">Single</option>
                    <option value="mixed">Mixed</option>
                    <option value="wholefarm">Whole farm</option>
                  </select>
                </div>
                <div class="field field-wide"><label>Output assumptions</label><input id="outputAssumptions" /></div>
              </div>

              <div class="spacer"></div>

              <div class="panel slim">
                <div class="panel-title-row">
                  <h4>Discount schedule</h4>
                  <div class="muted small">Optional schedule (low/base/high) by period.</div>
                </div>
                <div class="panel-body">
                  <div class="table-wrap compact">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Period</th>
                          <th>Low (%)</th>
                          <th>Base (%)</th>
                          <th>High (%)</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>2025–2034</td>
                          <td><input class="mini" data-disc-period="0" data-scenario="low" /></td>
                          <td><input class="mini" data-disc-period="0" data-scenario="base" /></td>
                          <td><input class="mini" data-disc-period="0" data-scenario="high" /></td>
                        </tr>
                        <tr>
                          <td>2035–2044</td>
                          <td><input class="mini" data-disc-period="1" data-scenario="low" /></td>
                          <td><input class="mini" data-disc-period="1" data-scenario="base" /></td>
                          <td><input class="mini" data-disc-period="1" data-scenario="high" /></td>
                        </tr>
                        <tr>
                          <td>2045–2054</td>
                          <td><input class="mini" data-disc-period="2" data-scenario="low" /></td>
                          <td><input class="mini" data-disc-period="2" data-scenario="base" /></td>
                          <td><input class="mini" data-disc-period="2" data-scenario="high" /></td>
                        </tr>
                        <tr>
                          <td>2055–2064</td>
                          <td><input class="mini" data-disc-period="3" data-scenario="low" /></td>
                          <td><input class="mini" data-disc-period="3" data-scenario="base" /></td>
                          <td><input class="mini" data-disc-period="3" data-scenario="high" /></td>
                        </tr>
                        <tr>
                          <td>2065–2074</td>
                          <td><input class="mini" data-disc-period="4" data-scenario="low" /></td>
                          <td><input class="mini" data-disc-period="4" data-scenario="base" /></td>
                          <td><input class="mini" data-disc-period="4" data-scenario="high" /></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="help">These schedule inputs are stored; the base case rate still drives the Results tab unless your JS uses the schedule in scenarios.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-title-row">
              <h3>Adoption & risk</h3>
              <div class="muted small">Used in base case and simulations.</div>
            </div>
            <div class="panel-body">
              <div class="row-6">
                <div class="field"><label>Adoption (base)</label><input id="adoptBase" type="number" step="0.01" min="0" max="1" /></div>
                <div class="field"><label>Adoption (low)</label><input id="adoptLow" type="number" step="0.01" min="0" max="1" /></div>
                <div class="field"><label>Adoption (high)</label><input id="adoptHigh" type="number" step="0.01" min="0" max="1" /></div>

                <div class="field"><label>Risk (base)</label><input id="riskBase" type="number" step="0.01" min="0" max="1" /></div>
                <div class="field"><label>Risk (low)</label><input id="riskLow" type="number" step="0.01" min="0" max="1" /></div>
                <div class="field"><label>Risk (high)</label><input id="riskHigh" type="number" step="0.01" min="0" max="1" /></div>
              </div>

              <div class="spacer"></div>

              <div class="panel slim">
                <div class="panel-title-row">
                  <h4>Risk components</h4>
                  <div class="muted small">Optional breakdown (kept for documentation and future extensions).</div>
                </div>
                <div class="panel-body">
                  <div class="row-6">
                    <div class="field"><label>Technical</label><input id="rTech" type="number" step="0.01" /></div>
                    <div class="field"><label>Non-cooperation</label><input id="rNonCoop" type="number" step="0.01" /></div>
                    <div class="field"><label>Socio</label><input id="rSocio" type="number" step="0.01" /></div>
                    <div class="field"><label>Financial</label><input id="rFin" type="number" step="0.01" /></div>
                    <div class="field"><label>Management</label><input id="rMan" type="number" step="0.01" /></div>
                  </div>
                </div>
              </div>

              <div class="spacer"></div>

              <div class="actions">
                <button class="btn primary" data-tab-jump="results" type="button">Update and view Results</button>
              </div>
            </div>
          </div>
        </section>
      </section>

      <!-- =========================
           OUTPUTS
           ========================= -->
      <section class="tab-panel" data-tab-panel="outputs" id="tab-outputs" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Outputs</h2>
            <p class="muted">Define output metrics (e.g., yield) and the $ value per unit used to monetise deltas.</p>
          </div>
          <div class="panel-head-actions">
            <button class="btn primary" id="addOutputBtn" type="button">Add output</button>
            <button class="btn ghost" data-tab-jump="results" type="button">Go to Results</button>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body">
            <div id="outputsList"></div>
          </div>
        </section>
      </section>

      <!-- =========================
           TREATMENTS
           ========================= -->
      <section class="tab-panel" data-tab-panel="treatments" id="tab-treatments" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Treatments</h2>
            <p class="muted">Edit treatment costs and output deltas. Set exactly one control baseline.</p>
          </div>
          <div class="panel-head-actions">
            <button class="btn primary" id="addTreatmentBtn" type="button">Add treatment</button>
            <button class="btn ghost" data-tab-jump="results" type="button">Go to Results</button>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body">
            <div class="callout">
              <strong>Control baseline:</strong> Use “Control vs treatment?” to select the single baseline.
              The Results table pins “Control (baseline)” beside every treatment.
            </div>
            <div id="treatmentsList"></div>
          </div>
        </section>
      </section>

      <!-- =========================
           BENEFITS
           ========================= -->
      <section class="tab-panel" data-tab-panel="benefits" id="tab-benefits" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Additional benefits</h2>
            <p class="muted">Optional benefits beyond output deltas (annual or once-off), with adoption/risk linking.</p>
          </div>
          <div class="panel-head-actions">
            <button class="btn primary" id="addBenefitBtn" type="button">Add benefit</button>
            <button class="btn ghost" data-tab-jump="results" type="button">Go to Results</button>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body">
            <div id="benefitsList"></div>
          </div>
        </section>
      </section>

      <!-- =========================
           COSTS
           ========================= -->
      <section class="tab-panel" data-tab-panel="costs" id="tab-costs" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Other costs</h2>
            <p class="muted">Project-level costs (annual or capital). Capital can optionally be depreciated for reporting.</p>
          </div>
          <div class="panel-head-actions">
            <button class="btn primary" id="addCostBtn" type="button">Add cost item</button>
            <button class="btn ghost" data-tab-jump="results" type="button">Go to Results</button>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body">
            <div id="costsList"></div>
          </div>
        </section>
      </section>

      <!-- =========================
           SIMULATIONS
           ========================= -->
      <section class="tab-panel" data-tab-panel="simulations" id="tab-simulations" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Simulations</h2>
            <p class="muted">Monte Carlo simulation to explore uncertainty around discount rate, adoption and risk, plus optional shocks.</p>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body">
            <div class="row-6">
              <div class="field">
                <label>Runs (N)</label>
                <input id="simN" type="number" min="100" step="100" />
              </div>
              <div class="field">
                <label>Target BCR</label>
                <input id="targetBCR" type="number" step="0.1" />
              </div>
              <div class="field">
                <label>BCR mode</label>
                <select id="bcrMode">
                  <option value="all">All costs</option>
                  <option value="constrained">Constrained costs</option>
                </select>
              </div>
              <div class="field">
                <label>Random seed (optional)</label>
                <input id="randSeed" placeholder="leave blank for random" />
              </div>
              <div class="field">
                <label>Variation (±%)</label>
                <input id="simVarPct" type="number" min="0" step="1" />
              </div>
              <div class="field">
                <label>&nbsp;</label>
                <button id="runSimBtn" class="btn primary" type="button">Run simulation</button>
                <div class="help" id="simStatus"></div>
              </div>
            </div>

            <div class="row-6">
              <div class="field">
                <label>Vary outputs?</label>
                <select id="simVaryOutputs">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div class="field">
                <label>Vary treatment costs?</label>
                <select id="simVaryTreatCosts">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div class="field">
                <label>Vary other costs?</label>
                <select id="simVaryInputCosts">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
            </div>

            <div class="spacer"></div>

            <div class="grid-2">
              <div class="panel slim">
                <div class="panel-title-row">
                  <h3>NPV distribution</h3>
                  <div class="muted small">Summary statistics across runs.</div>
                </div>
                <div class="panel-body">
                  <div class="inline-stats">
                    <div class="stat"><div class="muted small">Min</div><div id="simNpvMin" class="stat-val">$0</div></div>
                    <div class="stat"><div class="muted small">Max</div><div id="simNpvMax" class="stat-val">$0</div></div>
                    <div class="stat"><div class="muted small">Mean</div><div id="simNpvMean" class="stat-val">$0</div></div>
                    <div class="stat"><div class="muted small">Median</div><div id="simNpvMedian" class="stat-val">$0</div></div>
                    <div class="stat"><div class="muted small">P(NPV &gt; 0)</div><div id="simNpvProb" class="stat-val">n/a</div></div>
                  </div>
                  <div class="chart-card">
                    <canvas id="histNpv" width="720" height="260" aria-label="Histogram of NPV"></canvas>
                  </div>
                </div>
              </div>

              <div class="panel slim">
                <div class="panel-title-row">
                  <h3>BCR distribution</h3>
                  <div class="muted small">Includes probability thresholds.</div>
                </div>
                <div class="panel-body">
                  <div class="inline-stats">
                    <div class="stat"><div class="muted small">Min</div><div id="simBcrMin" class="stat-val">n/a</div></div>
                    <div class="stat"><div class="muted small">Max</div><div id="simBcrMax" class="stat-val">n/a</div></div>
                    <div class="stat"><div class="muted small">Mean</div><div id="simBcrMean" class="stat-val">n/a</div></div>
                    <div class="stat"><div class="muted small">Median</div><div id="simBcrMedian" class="stat-val">n/a</div></div>
                    <div class="stat"><div class="muted small">P(BCR &gt; 1)</div><div id="simBcrProb1" class="stat-val">n/a</div></div>
                    <div class="stat"><div class="muted small">P(BCR &gt; target)</div><div id="simBcrProbTarget" class="stat-val">n/a</div></div>
                  </div>
                  <div class="chart-card">
                    <canvas id="histBcr" width="720" height="260" aria-label="Histogram of BCR"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn ghost" data-tab-jump="results" type="button">Back to Results</button>
            </div>
          </div>
        </section>
      </section>

      <!-- =========================
           AI / COPILOT
           ========================= -->
      <section class="tab-panel" data-tab-panel="ai" id="tab-ai" hidden aria-hidden="true">
        <div class="panel-head">
          <div>
            <h2>Copilot / AI prompt</h2>
            <p class="muted">
              Generates a non-prescriptive prompt based only on the computed results (no invented numbers). Use it in Copilot or another assistant.
            </p>
          </div>
        </div>

        <section class="panel">
          <div class="panel-body">
            <div class="actions">
              <button class="btn primary" id="copyAIPrompt" type="button">Copy prompt</button>
              <button class="btn ghost" data-tab-jump="results" type="button">Go to Results</button>
            </div>

            <div class="field">
              <label>Prompt (editable)</label>
              <textarea id="aiPrompt" rows="22" spellcheck="false"></textarea>
              <div class="help">Tip: paste into Copilot and ask for a farmer-facing narrative interpretation without decision rules.</div>
            </div>
          </div>
        </section>
      </section>
    </main>

    <footer class="app-footer">
      <div class="footer-inner">
        <div class="muted small">
          <strong>Farming CBA Decision Tool 2</strong> • Newcastle Business School, The University of Newcastle
        </div>
        <div class="muted small">
          This tool is decision support. It does not prescribe choices or impose thresholds.
        </div>
      </div>
    </footer>

    <div id="toast-root" aria-live="polite" aria-atomic="true"></div>

    <!-- SheetJS (XLSX) must load before app.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script defer src="app.js"></script>

    <!-- Small glue so Data Import panel can mirror validation panel content, without changing app.js -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Keep the data tab's validation mirror in sync (best-effort, no dependency on app.js internals).
        const src = document.getElementById("validationPanel");
        const dst = document.getElementById("validationPanelDataMirror");
        if (!src || !dst) return;

        const sync = () => (dst.innerHTML = src.innerHTML);
        sync();

        const mo = new MutationObserver(sync);
        mo.observe(src, { childList: true, subtree: true });

        // Ensure Results is the visible landing tab even if JS initialisation changes.
        // app.js should handle tabs; this is a harmless fallback.
        const resultsTabBtn = document.querySelector('[data-tab-target="results"]');
        if (resultsTabBtn && !resultsTabBtn.classList.contains("active")) resultsTabBtn.click();
      });
    </script>
  </body>
</html>
