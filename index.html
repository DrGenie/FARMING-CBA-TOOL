<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farming CBA Decision Tool 2</title>

  <!-- World Bank–style typography and clean layout relies on styles.css (recommended).
       This file provides the complete, aligned HTML structure and IDs used by app.js. -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Optional: XLSX (enables Excel upload + workbook export). If not present, tool still works with TSV/CSV. -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script defer src="app.js"></script>
</head>

<body>
  <header class="wb-header">
    <div class="wb-header__inner">
      <div class="wb-brand">
        <div class="wb-mark" aria-hidden="true">WB</div>
        <div class="wb-brand__text">
          <div class="wb-title">Farming CBA Decision Tool 2</div>
          <div class="wb-subtitle">Control-centric trial economics and sensitivity analysis</div>
        </div>
      </div>

      <div class="wb-header__meta">
        <div class="wb-pill">
          <span class="wb-pill__label">Dataset</span>
          <span class="wb-pill__value" id="headerDatasetName">None loaded</span>
        </div>
        <div class="wb-pill">
          <span class="wb-pill__label">Status</span>
          <span class="wb-pill__value" id="lastUpdatedStamp">Updated</span>
        </div>
      </div>
    </div>

    <nav class="wb-nav" aria-label="Primary">
      <button class="tab-btn" data-tab="intro" type="button">Introduction</button>
      <button class="tab-btn" data-tab="import" type="button">Data Import</button>
      <button class="tab-btn" data-tab="config" type="button">Configuration</button>
      <button class="tab-btn active" data-tab="results" type="button">Results</button>
      <button class="tab-btn" data-tab="sensitivity" type="button">Sensitivity</button>
      <button class="tab-btn" data-tab="ai" type="button">AI Briefing</button>
      <button class="tab-btn" data-tab="appendix" type="button">Appendix</button>
    </nav>
  </header>

  <main class="wb-main">
    <!-- INTRO -->
    <section class="tab-panel" id="tab-intro">
      <div class="wb-grid">
        <section class="wb-card wb-card--span2">
          <h2 class="wb-h2">What this tool does</h2>
          <p class="wb-p">
            This tool compares every treatment against a control baseline. It converts yield changes into revenue using a grain price,
            applies discounted cashflows over a chosen time horizon, and shows present value benefits, present value costs, net present value,
            benefit–cost ratio, and return on investment.
          </p>
          <p class="wb-p">
            Import your trial dataset using upload or paste. The tool detects control and replicate baselines, computes plot-level deltas,
            then calibrates treatments so the Results table always presents “Control versus all treatments”.
          </p>
          <div class="wb-callout">
            <div class="wb-callout__title">Tip</div>
            <div class="wb-callout__body">
              Put <code>faba_beans_trial_clean_named.tsv</code> (and optionally <code>faba_beans_trial_data_dictionary_FULL.csv</code>)
              next to <code>index.html</code> on GitHub Pages to load default data automatically.
            </div>
          </div>
        </section>

        <section class="wb-card">
          <h2 class="wb-h2">Quick actions</h2>

          <div class="wb-actions">
            <button class="btn" id="btnLoadDefault" type="button">Load default trial data</button>
            <button class="btn btn-secondary" id="btnOpenAppendix" type="button">Open technical appendix</button>
          </div>

          <hr class="wb-hr" />

          <h3 class="wb-h3">Scenario storage</h3>
          <p class="wb-p small muted">Save and restore scenarios in this browser (settings, treatments, and notes).</p>

          <div class="wb-form">
            <label class="wb-label" for="scenarioName">Scenario name</label>
            <input class="wb-input" id="scenarioName" type="text" placeholder="e.g., Base case (Jan 2026)" />
          </div>

          <div class="wb-actions">
            <button class="btn" id="btnSaveScenario" type="button">Save scenario</button>
          </div>

          <div class="wb-form">
            <label class="wb-label" for="scenarioSelect">Saved scenarios</label>
            <select class="wb-select" id="scenarioSelect"></select>
          </div>

          <div class="wb-actions">
            <button class="btn" id="btnLoadScenario" type="button">Load selected</button>
            <button class="btn btn-danger" id="btnDeleteScenario" type="button">Delete selected</button>
          </div>
        </section>
      </div>
    </section>

    <!-- IMPORT -->
    <section class="tab-panel" id="tab-import">
      <div class="wb-grid">
        <section class="wb-card wb-card--span2">
          <h2 class="wb-h2">Data import</h2>
          <p class="wb-p">
            Upload TSV, CSV, or Excel. You can also paste tabular content directly. If your paste includes a data dictionary section followed by the data section,
            the tool will split and parse both.
          </p>

          <div class="wb-split">
            <div>
              <h3 class="wb-h3">Upload</h3>
              <input id="fileUpload" type="file" class="wb-file" accept=".tsv,.csv,.txt,.xlsx,.xls" />
              <div class="wb-actions">
                <button class="btn" id="btnStageUpload" type="button">Stage upload</button>
                <button class="btn btn-primary" id="btnCommitStaged" type="button">Commit staged dataset</button>
              </div>
            </div>

            <div>
              <h3 class="wb-h3">Paste</h3>
              <textarea id="pasteData" class="wb-textarea" rows="10" placeholder="Paste TSV or CSV content here."></textarea>
              <div class="wb-actions">
                <button class="btn" id="btnStagePaste" type="button">Stage paste</button>
                <button class="btn btn-primary" id="btnCommitStaged" type="button">Commit staged dataset</button>
              </div>
            </div>
          </div>

          <hr class="wb-hr" />

          <h3 class="wb-h3">Import status</h3>
          <div class="wb-pill wb-pill--wide">
            <span class="wb-pill__label">Summary</span>
            <span class="wb-pill__value" id="importSummary"></span>
          </div>
          <div class="wb-pill wb-pill--wide">
            <span class="wb-pill__label">Details</span>
            <span class="wb-pill__value" id="importStatus"></span>
          </div>

          <h3 class="wb-h3">Data checks</h3>
          <div id="dataChecks"></div>
        </section>

        <section class="wb-card">
          <h2 class="wb-h2">Exports</h2>
          <p class="wb-p small muted">Exports reflect the committed dataset and the latest computed results.</p>

          <div class="wb-actions">
            <button class="btn" id="btnExportCleaned" type="button">Download cleaned dataset (TSV)</button>
            <button class="btn" id="btnExportSummary" type="button">Download treatment summary (CSV)</button>
            <button class="btn" id="btnExportWorkbook" type="button">Download workbook (XLSX)</button>
          </div>

          <hr class="wb-hr" />

          <h3 class="wb-h3">Note</h3>
          <p class="wb-p small muted">
            Workbook export and Excel upload require the XLSX library. If it does not load, use TSV/CSV upload.
          </p>
        </section>
      </div>
    </section>

    <!-- CONFIG -->
    <section class="tab-panel" id="tab-config">
      <div class="wb-grid">
        <section class="wb-card wb-card--span2">
          <h2 class="wb-h2">Configuration</h2>

          <div class="wb-grid2">
            <div class="wb-form">
              <label class="wb-label" for="grainPrice">Grain price (per tonne)</label>
              <input class="wb-input" id="grainPrice" type="number" step="1" placeholder="e.g., 450" />
              <div class="small muted">Used to value yield deltas in t/ha.</div>
            </div>

            <div class="wb-form">
              <label class="wb-label" for="yearsHorizon">Time horizon (years)</label>
              <input class="wb-input" id="yearsHorizon" type="number" step="1" min="1" value="10" />
            </div>

            <div class="wb-form">
              <label class="wb-label" for="discountRateBase">Discount rate (base, %)</label>
              <input class="wb-input" id="discountRateBase" type="number" step="0.1" value="7" />
            </div>

            <div class="wb-form">
              <label class="wb-label" for="persistenceYears">Yield persistence (years)</label>
              <input class="wb-input" id="persistenceYears" type="number" step="1" min="0" value="5" />
              <div class="small muted">Number of years yield lift is applied after application.</div>
            </div>

            <div class="wb-form">
              <label class="wb-label" for="adoptionMultiplier">Adoption multiplier (0 to 1)</label>
              <input class="wb-input" id="adoptionMultiplier" type="number" step="0.01" min="0" max="1" value="1" />
            </div>

            <div class="wb-form">
              <label class="wb-label" for="riskMultiplier">Risk multiplier (0 to 1)</label>
              <input class="wb-input" id="riskMultiplier" type="number" step="0.01" min="0" max="1" value="0.15" />
              <div class="small muted">Reduces benefits by this proportion.</div>
            </div>
          </div>

          <hr class="wb-hr" />

          <h3 class="wb-h3">Outputs</h3>
          <div id="outputsList"></div>

          <hr class="wb-hr" />

          <h3 class="wb-h3">Treatments</h3>
          <p class="wb-p small muted">Treatments are calibrated from the committed dataset. You can adjust incremental inputs here.</p>
          <div id="treatmentsList"></div>
        </section>

        <section class="wb-card">
          <h2 class="wb-h2">Sensitivity settings</h2>
          <p class="wb-p small muted">Enter comma-separated lists. Click “Update sensitivity settings”.</p>

          <div class="wb-form">
            <label class="wb-label" for="sensPrice">Grain price grid</label>
            <input class="wb-input" id="sensPrice" type="text" />
          </div>

          <div class="wb-form">
            <label class="wb-label" for="sensDiscount">Discount rate grid (%)</label>
            <input class="wb-input" id="sensDiscount" type="text" />
          </div>

          <div class="wb-form">
            <label class="wb-label" for="sensPersistence">Persistence grid (years)</label>
            <input class="wb-input" id="sensPersistence" type="text" />
          </div>

          <div class="wb-form">
            <label class="wb-label" for="sensRecurrence">Recurrence grid (years, 0 means once)</label>
            <input class="wb-input" id="sensRecurrence" type="text" />
          </div>

          <div class="wb-actions">
            <button class="btn" id="btnUpdateSensitivitySettings" type="button">Update sensitivity settings</button>
          </div>
        </section>
      </div>
    </section>

    <!-- RESULTS -->
    <section class="tab-panel active" id="tab-results">
      <div class="wb-grid">
        <section class="wb-card wb-card--span2">
          <div class="wb-results-head">
            <h2 class="wb-h2">Results</h2>
            <div class="wb-pill wb-pill--wide">
              <span class="wb-pill__label">Base case</span>
              <span class="wb-pill__value" id="baseCaseBadge"></span>
            </div>
          </div>

          <div class="wb-actions">
            <button class="btn" id="btnFilterAll" type="button">Show all</button>
            <button class="btn" id="btnFilterTopNpv" type="button">Top 5 by NPV</button>
            <button class="btn" id="btnFilterTopBcr" type="button">Top 5 by BCR</button>
            <button class="btn" id="btnFilterImprove" type="button">Show only improvements vs control</button>
          </div>

          <h3 class="wb-h3">Leaderboard</h3>
          <div id="resultsLeaderboard"></div>

          <h3 class="wb-h3">Comparison to control</h3>
          <div id="comparisonToControl"></div>

          <h3 class="wb-h3">What this means</h3>
          <pre class="wb-narrative" id="resultsNarrative"></pre>
        </section>

        <section class="wb-card">
          <h2 class="wb-h2">Plots</h2>

          <h3 class="wb-h3">NPV bar chart</h3>
          <div class="wb-chart">
            <canvas id="chartNpv" width="800" height="360"></canvas>
          </div>

          <hr class="wb-hr" />

          <h3 class="wb-h3">Cashflow line</h3>
          <div class="wb-form">
            <label class="wb-label" for="cashflowTreatmentSelect">Treatment</label>
            <select class="wb-select" id="cashflowTreatmentSelect"></select>
          </div>
          <div class="wb-chart">
            <canvas id="chartCashflow" width="800" height="360"></canvas>
          </div>

          <hr class="wb-hr" />

          <div class="wb-actions">
            <button class="btn btn-secondary" id="btnOpenAppendix" type="button">Open technical appendix</button>
          </div>
        </section>
      </div>
    </section>

    <!-- SENSITIVITY -->
    <section class="tab-panel" id="tab-sensitivity">
      <div class="wb-grid">
        <section class="wb-card wb-card--span2">
          <h2 class="wb-h2">Sensitivity</h2>
          <p class="wb-p">
            Sensitivity runs the CBA engine across a grid of grain prices, discount rates, persistence years, and recurrence years.
            Use exports for the full grid. The summary below focuses on stability rather than a single point estimate.
          </p>

          <div class="wb-actions">
            <button class="btn btn-primary" id="btnRunSensitivity" type="button">Run sensitivity grid</button>
            <button class="btn" id="btnExportSensitivity" type="button">Download sensitivity grid (CSV)</button>
          </div>

          <h3 class="wb-h3">Sensitivity summary</h3>
          <div id="sensitivitySummary"></div>
        </section>

        <section class="wb-card">
          <h2 class="wb-h2">Notes</h2>
          <p class="wb-p small muted">
            The recurrence setting determines how often incremental per-hectare application costs are repeated.
            A value of 0 means a one-off application at year 0. Positive values repeat at that interval.
          </p>
          <p class="wb-p small muted">
            If your trial costs include multiple columns, the tool groups them into labour, services, and materials for treatment inputs.
            This grouping is based on column names and can be refined in your dataset naming.
          </p>
        </section>
      </div>
    </section>

    <!-- AI -->
    <section class="tab-panel" id="tab-ai">
      <div class="wb-grid">
        <section class="wb-card wb-card--span2">
          <h2 class="wb-h2">AI briefing</h2>
          <p class="wb-p">
            Copy the prompt and paste it into your preferred writing assistant. The prompt includes the computed results JSON at the end.
          </p>

          <div class="wb-actions">
            <button class="btn btn-primary" id="btnCopyAiBrief" type="button">Copy briefing prompt</button>
          </div>

          <textarea id="aiBriefingText" class="wb-textarea" rows="18"></textarea>
        </section>

        <section class="wb-card">
          <h2 class="wb-h2">Results JSON</h2>
          <p class="wb-p small muted">Copy-ready JSON for reporting or downstream analysis.</p>

          <div class="wb-actions">
            <button class="btn" id="btnCopyResultsJson" type="button">Copy results JSON</button>
          </div>

          <textarea id="resultsJson" class="wb-textarea" rows="18"></textarea>
        </section>
      </div>
    </section>

    <!-- APPENDIX -->
    <section class="tab-panel" id="tab-appendix">
      <div class="wb-grid">
        <section class="wb-card wb-card--span2">
          <h2 class="wb-h2">Technical appendix</h2>
          <p class="wb-p">
            Opens a separate appendix page using the currently committed dataset, data checks, calibrated treatments, base case results, and sensitivity grid (if run).
            The appendix payload is stored in browser storage just before the new tab opens.
          </p>

          <div class="wb-actions">
            <button class="btn btn-primary" id="btnOpenAppendix" type="button">Open technical appendix</button>
          </div>

          <hr class="wb-hr" />

          <h3 class="wb-h3">Data checks</h3>
          <div id="dataChecks"></div>
        </section>

        <section class="wb-card">
          <h2 class="wb-h2">Appendix file</h2>
          <p class="wb-p small muted">
            Ensure <code>technical-appendix.html</code> exists in the same folder as this page.
            It should read the payload from <code>localStorage</code> key <code>farming_cba_appendix_payload_v2</code>.
          </p>
        </section>
      </div>
    </section>
  </main>

  <footer class="wb-footer">
    <div class="wb-footer__inner">
      <div class="small muted">Newcastle Business School · Farming CBA Decision Tool 2</div>
    </div>
  </footer>

  <!-- Toast root is created by app.js if missing -->
</body>
</html>
