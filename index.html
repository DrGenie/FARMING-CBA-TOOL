<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Faba Beans Trial CBA Decision Aid - Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-theme="worldbank-light">
  <div id="appRoot">
    <!-- Toasts -->
    <div id="toastHost" aria-live="polite" aria-atomic="true"></div>
    <div id="toastRegion" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <!-- Modal -->
    <div id="modalOverlay" class="modal-overlay" hidden></div>
    <div id="modalShell" class="modal-shell" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
      <div class="modal-header">
        <div id="modalTitle" class="modal-title">Dialog</div>
        <button id="modalClose" class="btn icon" type="button" aria-label="Close dialog">✕</button>
      </div>
      <div id="modalBody" class="modal-body">
        <!-- Scenario manager content is injected or toggled by JS; the ID below must exist -->
        <div id="modalScenarioManager" hidden>
          <div class="card subtle">
            <h3>Scenario lists</h3>
            <p class="small muted">
              Update grain prices, discount rates, and yield persistence patterns. Changes apply across the tool.
            </p>

            <div class="row-3">
              <div class="field">
                <label for="inputAddPrice" data-tooltip="Add a new grain price scenario in Australian dollars per tonne.">
                  Add grain price (AUD per tonne)
                </label>
                <div class="inline">
                  <input id="inputAddPrice" type="number" step="1" min="0" />
                  <button id="btnAddPrice" class="btn" type="button">Add</button>
                </div>
                <div id="managePricesList" class="list-box" aria-label="Grain price scenarios"></div>
              </div>

              <div class="field">
                <label for="inputAddDiscount" data-tooltip="Add a new discount rate as a decimal value, for example 0.07 for 7 percent.">
                  Add discount rate (decimal)
                </label>
                <div class="inline">
                  <input id="inputAddDiscount" type="number" step="0.001" min="0" max="1" />
                  <button id="btnAddDiscount" class="btn" type="button">Add</button>
                </div>
                <div id="manageDiscountsList" class="list-box" aria-label="Discount rate scenarios"></div>
              </div>

              <div class="field">
                <label for="inputPersistenceName" data-tooltip="Name for the yield persistence pattern. Use plain words that describe how long the yield effect lasts.">
                  Yield persistence name
                </label>
                <input id="inputPersistenceName" type="text" />
                <label for="inputPersistenceVector" data-tooltip="Comma-separated numbers for each year of the time horizon. For example 1,0.5,0.25,0,0...">
                  Yield persistence vector (comma-separated)
                </label>
                <div class="inline">
                  <input id="inputPersistenceVector" type="text" class="mono" placeholder="1, 0.8, 0.6, 0.4, 0.2, 0, 0, 0, 0, 0" />
                  <button id="btnAddPersistence" class="btn" type="button">Add</button>
                </div>
                <div id="managePersistenceList" class="list-box" aria-label="Yield persistence patterns"></div>
              </div>
            </div>

            <div class="toolbar right">
              <button id="btnSaveScenarioManager" class="btn primary" type="button">Save scenario lists</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header id="topBar" class="app-header">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true">NBS</div>
        <div class="brand-text">
          <div id="appTitle" class="brand-title">Faba Beans Trial CBA Decision Aid</div>
          <div id="appSubtitle" class="brand-subtitle">Newcastle Business School</div>
        </div>
      </div>

      <div class="header-actions">
        <div id="activeDatasetBadge" class="badge" role="status" aria-live="polite">Dataset: not loaded</div>
        <a id="navTechnicalAppendix" class="btn ghost" href="technical-appendix.html" target="_blank" rel="noopener">
          Technical appendix
        </a>
      </div>
    </header>

    <!-- Primary navigation -->
    <nav id="navPrimary" class="tabs-nav" aria-label="Main sections">
      <button id="navResults" type="button" class="tab-link active" aria-selected="true">Results</button>
      <button id="navImport" type="button" class="tab-link" aria-selected="false">Data import</button>
      <button id="navDiagnostics" type="button" class="tab-link" aria-selected="false">Diagnostics</button>
      <button id="navConfiguration" type="button" class="tab-link" aria-selected="false">Configuration</button>
      <button id="navAIBriefing" type="button" class="tab-link" aria-selected="false">AI briefing</button>
      <button id="navExports" type="button" class="tab-link" aria-selected="false">Exports</button>
    </nav>

    <main class="app-main">
      <!-- RESULTS TAB (default open) -->
      <section id="tabResults" class="tab-panel active show" aria-hidden="false">
        <div class="card">
          <div id="resultsHeader" class="results-header">
            <div class="left">
              <h2>Comparison to control</h2>
              <div id="resultsStatusLine" class="small muted" role="status">
                Load and commit a dataset to view results.
              </div>
            </div>
            <div class="right">
              <a class="btn ghost" href="technical-appendix.html" target="_blank" rel="noopener">
                How the calculations work
              </a>
            </div>
          </div>

          <!-- Scenario bar -->
          <div id="scenarioBar" class="card subtle">
            <div class="row-5">
              <div class="field">
                <label for="inputTimeHorizon" data-tooltip="Number of years used in the discounted cash-flow calculations.">
                  Time horizon (years)
                </label>
                <input id="inputTimeHorizon" type="number" min="1" step="1" value="10" />
              </div>
              <div class="field">
                <label for="selectPriceScenario" data-tooltip="Grain price used to value yield changes.">
                  Grain price (AUD per tonne)
                </label>
                <select id="selectPriceScenario"></select>
              </div>
              <div class="field">
                <label for="selectDiscountRate" data-tooltip="Discount rate used to convert future costs and benefits to present values.">
                  Discount rate (decimal)
                </label>
                <select id="selectDiscountRate"></select>
              </div>
              <div class="field">
                <label for="selectPersistencePattern" data-tooltip="How long the yield effect lasts across years.">
                  Yield persistence
                </label>
                <select id="selectPersistencePattern"></select>
              </div>
              <div class="field">
                <label for="selectViewScale" data-tooltip="Choose whether results are shown per hectare or scaled to a total farm area.">
                  View scale
                </label>
                <select id="selectViewScale">
                  <option value="per_ha">Per hectare</option>
                  <option value="ha_100">100 hectares</option>
                  <option value="ha_3300">3300 hectares</option>
                </select>
              </div>
            </div>

            <div class="row-2">
              <div id="scenarioHelp" class="small muted">
                The main table uses the selected settings. Rankings update within each scenario slice.
              </div>
              <div class="toolbar right">
                <button id="btnManageScenarios" class="btn" type="button">Manage scenarios</button>
              </div>
            </div>
          </div>

          <!-- Leaderboard -->
          <div id="leaderboardCard" class="card subtle">
            <div class="results-header compact">
              <h3>Leaderboard</h3>
              <div id="leaderboardFilters" class="btn-group" role="group" aria-label="Quick filters">
                <button id="filterTopNPV" type="button" class="btn small">Top 5 by net present value</button>
                <button id="filterTopBCR" type="button" class="btn small">Top 5 by benefit–cost ratio</button>
                <button id="filterOnlyImprovements" type="button" class="btn small">Improvements only</button>
                <button id="filterShowAll" type="button" class="btn small ghost">Show all</button>
              </div>
            </div>

            <div id="leaderboardTableWrap" class="table-scroll xscroll">
              <table id="leaderboardTable" class="summary-table" aria-label="Leaderboard table">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Treatment</th>
                    <th>Net present value</th>
                    <th>Net present value (100 hectares)</th>
                    <th>Net present value (3300 hectares)</th>
                    <th>Present value of benefits</th>
                    <th>Present value of costs</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Comparison to Control -->
          <div id="comparisonCard" class="card subtle">
            <div class="results-header compact">
              <h3>Comparison to control</h3>
              <div class="small muted">
                Indicators are rows and treatments are columns. The control column is pinned.
              </div>
            </div>

            <div id="comparisonTableWrap" class="table-scroll xscroll sticky-grid" aria-label="Comparison table wrapper">
              <table id="comparisonTable" class="summary-table" aria-label="Comparison to control table">
                <thead>
                  <tr>
                    <th>Indicator</th>
                    <th>Control (baseline)</th>
                    <!-- Treatment columns injected by JS -->
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div id="resultsNotes" class="small muted">
              Values reflect the chosen grain price, discount rate, and yield persistence. Benefit–cost ratio and return on investment are shown as not applicable when present value of costs is zero or negative.
            </div>
          </div>

          <!-- What this means -->
          <div id="whatThisMeansCard" class="card subtle">
            <h3>What this means</h3>
            <div id="whatThisMeansText" class="prose">
              Commit a dataset to generate a plain-language interpretation for the selected scenario.
            </div>
          </div>
        </div>
      </section>

      <!-- IMPORT TAB -->
      <section id="tabImport" class="tab-panel" aria-hidden="true" hidden>
        <div class="card">
          <h2>Data import and validation</h2>
          <p class="small muted">
            Upload or paste the trial dataset (tab-separated preferred) and the data dictionary (CSV). Then validate and commit.
          </p>

          <div id="importSteps" class="card subtle">
            <h3>Step 1: Provide the dataset and dictionary</h3>

            <div class="row-2">
              <div class="field">
                <label for="inputDataFile" data-tooltip="Upload the full dataset as TSV or CSV. Tab-separated text is preferred.">
                  Upload dataset (TSV or CSV)
                </label>
                <input id="inputDataFile" type="file" accept=".tsv,.csv,.txt,text/tab-separated-values,text/csv,text/plain" />
                <label for="inputDataPaste" data-tooltip="Paste the full dataset as tab-delimited text. Do not remove columns or rows.">
                  Or paste dataset (tab-delimited)
                </label>
                <textarea id="inputDataPaste" rows="10" class="mono" placeholder="Paste tab-delimited data here"></textarea>
              </div>

              <div class="field">
                <label for="inputDictFile" data-tooltip="Upload the data dictionary as CSV. Field labels and validation use this file.">
                  Upload dictionary (CSV)
                </label>
                <input id="inputDictFile" type="file" accept=".csv,text/csv" />
                <label for="inputDictPaste" data-tooltip="Paste the dictionary as CSV text.">
                  Or paste dictionary (CSV)
                </label>
                <textarea id="inputDictPaste" rows="10" class="mono" placeholder="Paste dictionary CSV here"></textarea>
              </div>
            </div>

            <div class="toolbar">
              <button id="btnParseInputs" class="btn" type="button">Parse inputs</button>
              <button id="btnValidate" class="btn primary" type="button">Validate</button>
              <button id="btnCommit" class="btn" type="button">Commit dataset</button>
              <div class="spacer"></div>
              <button id="btnResetSession" class="btn ghost" type="button">Reset</button>
            </div>

            <div id="importStatus" class="small muted" role="status">No data parsed yet.</div>

            <div id="importWarnings" class="callouts" aria-label="Validation warnings"></div>

            <div id="importPreviewMeta" class="card subtle">
              <h3>Preview</h3>
              <p class="small muted">
                This preview shows key counts and fields. The tool uses the full dataset as provided.
              </p>
              <div id="previewKeyFieldsTable" class="table-scroll">
                <table class="summary-table" aria-label="Key fields preview table">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Value</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div id="dataChecksCard" class="card subtle">
              <h3>Data checks: amendment input cost scaling</h3>
              <p class="small muted">
                When the amendment input cost looks about 100 times too large, the tool divides it by 100 and reconstructs the total cost per hectare.
              </p>
              <div id="scalingRuleSummary" class="small muted">No scaling checks run yet.</div>
              <div id="scalingRuleTable" class="table-scroll">
                <table class="summary-table" aria-label="Scaling rule table">
                  <thead>
                    <tr>
                      <th>Amendment</th>
                      <th>Plots</th>
                      <th>Raw input cost (summary)</th>
                      <th>Adjusted input cost (summary)</th>
                      <th>Total cost change (summary)</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="card subtle">
              <h3>Exports from imported data</h3>
              <div class="toolbar">
                <button id="btnExportCleanTSV" class="btn" type="button">Export cleaned dataset (TSV)</button>
                <button id="btnExportTreatmentSummaryCSV" class="btn" type="button">Export treatment summary (CSV)</button>
                <button id="btnExportSensitivityGridCSV" class="btn" type="button">Export full sensitivity grid (CSV)</button>
                <button id="btnExportCSVPackZip" class="btn ghost" type="button">Export all as a pack</button>
              </div>
              <p class="small muted">
                Exports are designed to open cleanly in Excel and to paste into Word without formatting issues.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- DIAGNOSTICS TAB -->
      <section id="tabDiagnostics" class="tab-panel" aria-hidden="true" hidden>
        <div class="card">
          <h2>Diagnostics</h2>
          <p class="small muted">
            These checks highlight missing controls by replicate, missing critical fields, small sample sizes, and any cost scaling triggers.
          </p>

          <div id="diagnosticsSummaryCard" class="card subtle">
            <div class="results-header compact">
              <h3>Summary</h3>
              <div class="toolbar right">
                <button id="btnRunDiagnostics" class="btn primary" type="button">Run diagnostics</button>
              </div>
            </div>
            <div id="diagnosticsSummaryText" class="prose">
              Commit a dataset to view diagnostics.
            </div>
          </div>

          <div class="card subtle">
            <h3>Details</h3>
            <div id="diagnosticsTableWrap" class="table-scroll">
              <table id="diagnosticsTable" class="summary-table" aria-label="Diagnostics table">
                <thead>
                  <tr>
                    <th>Check</th>
                    <th>Status</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- CONFIGURATION TAB -->
      <section id="tabConfiguration" class="tab-panel" aria-hidden="true" hidden>
        <div class="card">
          <h2>Configuration</h2>
          <p class="small muted">
            Choose how costs recur for each treatment and whether a treatment is included in rankings.
          </p>

          <div id="configSummaryCard" class="card subtle">
            <div class="results-header compact">
              <h3>Current configuration at a glance</h3>
              <div class="toolbar right">
                <button id="btnApplyConfiguration" class="btn primary" type="button">Apply configuration</button>
                <button id="btnViewResultsSummary" class="btn" type="button">View results summary</button>
              </div>
            </div>
            <div id="configSummaryText" class="prose">
              Commit a dataset to configure treatments.
            </div>
          </div>

          <div class="card subtle">
            <h3>Treatments</h3>
            <div id="configTableWrap" class="table-scroll xscroll">
              <table id="configTable" class="summary-table" aria-label="Configuration table">
                <thead>
                  <tr>
                    <th>Treatment name</th>
                    <th>Control</th>
                    <th>Cost recurrence</th>
                    <th>Include in rankings</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="toolbar">
              <button id="btnSaveScenario" class="btn" type="button">Save scenario</button>
              <button id="btnLoadScenario" class="btn ghost" type="button">Load scenario</button>
              <div class="spacer"></div>
              <div id="scenarioStoreStatus" class="small muted" role="status">No scenario saved or loaded yet.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- AI BRIEFING TAB -->
      <section id="tabAIBriefing" class="tab-panel" aria-hidden="true" hidden>
        <div class="card">
          <h2>AI briefing</h2>
          <div id="aiBriefingIntro" class="small muted">
            This creates a copy-ready briefing prompt and a structured results JSON based only on the computed results for the selected scenario.
          </div>

          <div class="row-2">
            <div class="field">
              <label for="aiBriefingPrompt" data-tooltip="Copy-ready prompt written in plain language.">
                Briefing prompt
              </label>
              <textarea id="aiBriefingPrompt" rows="14" class="mono"></textarea>
              <div class="toolbar">
                <button id="btnCopyBriefingPrompt" class="btn primary" type="button">Copy briefing prompt</button>
              </div>
            </div>

            <div class="field">
              <label for="aiResultsJSON" data-tooltip="Structured results JSON that another system can ingest.">
                Results JSON
              </label>
              <textarea id="aiResultsJSON" rows="14" class="mono"></textarea>
              <div class="toolbar">
                <button id="btnCopyResultsJSON" class="btn" type="button">Copy results JSON</button>
              </div>
            </div>
          </div>

          <div id="aiBriefingStatus" class="small muted" role="status">Commit a dataset to generate the briefing content.</div>
        </div>
      </section>

      <!-- EXPORTS TAB -->
      <section id="tabExports" class="tab-panel" aria-hidden="true" hidden>
        <div class="card">
          <h2>Exports</h2>
          <div id="exportsIntro" class="small muted">
            Export the current scenario slice in a format that opens cleanly in Excel.
          </div>

          <div id="exportButtonsGroup" class="card subtle">
            <div class="toolbar">
              <button id="btnExportResultsSliceCSV" class="btn primary" type="button">Export current results slice (CSV)</button>
              <button id="btnExportResultsSliceTSV" class="btn" type="button">Export current results slice (TSV)</button>
              <button id="btnExportWorkbookXLSX" class="btn ghost" type="button">Export workbook (XLSX)</button>
            </div>
            <div id="exportStatus" class="small muted" role="status">No export prepared yet.</div>
          </div>

          <div class="card subtle">
            <h3>Tip</h3>
            <p class="small muted">
              For full transparency, also export the cleaned dataset and full sensitivity grid from the Data import tab.
            </p>
          </div>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      <div class="footer-left">
        <span class="small muted">Faba Beans Trial CBA Decision Aid, Newcastle Business School</span>
      </div>
      <div class="footer-right">
        <a class="btn small ghost" href="technical-appendix.html" target="_blank" rel="noopener">Technical appendix</a>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
