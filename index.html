<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farming CBA Decision Tool 2</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- SheetJS for Excel upload/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
  <script src="app.js" defer></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="mark">F</div>
      <div class="brand-text">
        <div class="title">Farming CBA Decision Tool 2</div>
        <div class="subtitle">Compare treatments against a control, using an Excel-first workflow</div>
      </div>
    </div>

    <div class="actions">
      <label class="file-pill">
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
        <span>Upload Excel</span>
      </label>
      <span class="status" id="uploadStatus">No file loaded</span>
      <button class="btn" id="btnTemplate" type="button">Download template</button>
      <button class="btn ghost" id="btnResetSample" type="button">Load embedded sample</button>
      <button class="btn primary" id="btnRun" type="button">Run analysis</button>
    </div>
  </header>

  <main class="shell">
    <nav class="tabs" aria-label="Tool tabs">
      <button class="tab-btn active" data-tab="tab-overview" type="button">Overview</button>
      <button class="tab-btn" data-tab="tab-data" type="button">Data</button>
      <button class="tab-btn" data-tab="tab-assumptions" type="button">Assumptions</button>
      <button class="tab-btn" data-tab="tab-results" type="button">Results</button>
      <button class="tab-btn" data-tab="tab-sensitivity" type="button">Sensitivity</button>
      <button class="tab-btn" data-tab="tab-export" type="button">Export</button>
      <button class="tab-btn" data-tab="tab-help" type="button">Help</button>
    </nav>

    <section id="tab-overview" class="tab-panel active">
      <div class="grid2">
        <div class="card">
          <h2>What this tool does</h2>
          <p>
            This tool compares every treatment against a nominated control. The main Results table uses a vertical layout:
            indicators are rows and treatments are columns, so you can scan each indicator across all options quickly.
          </p>
          <p class="muted">
            You can upload either (i) a trial-style worksheet that contains “Amendment” and “Yield t/ha”, or (ii) the provided
            CBA template with “Treatment, Year, Benefit, Cost”.
          </p>
          <div class="callout">
            <strong>Tip:</strong> If you upload your trial spreadsheet, the tool summarises yields and costs by treatment, then
            converts yield differences into dollar benefits using the price you set under Assumptions.
          </div>
        </div>

        <div class="card">
          <h2>Current dataset</h2>
          <div class="kv">
            <div class="k">Source</div><div class="v" id="dataSource">—</div>
            <div class="k">Detected format</div><div class="v" id="dataFormat">—</div>
            <div class="k">Control</div><div class="v" id="controlName">—</div>
          </div>
          <p class="muted">
            If a file fails to load, go to the Data tab to see the detailed error message.
          </p>
        </div>
      </div>
    </section>

    <section id="tab-data" class="tab-panel">
      <div id="errorBox" class="error">
        <div class="error-head">
          <strong>Upload error</strong>
          <button id="btnDismissError" class="btn tiny ghost" type="button">Dismiss</button>
        </div>
        <pre class="error-body" id="errorText"></pre>
      </div>

      <div class="card">
        <h2>Loaded data preview</h2>
        <p class="muted">
          Trial uploads are shown as treatment-level summaries (mean yield and mean cost per hectare). Template uploads are
          summarised after you run the analysis.
        </p>
        <div id="treatmentList"></div>
      </div>
    </section>

    <section id="tab-assumptions" class="tab-panel">
      <div class="card">
        <h2>Assumptions</h2>
        <div class="form-grid">
          <label>
            Discount rate (%)
            <input id="discountRate" type="number" step="0.1" min="0" max="50" />
          </label>

          <label>
            Horizon (years)
            <input id="horizonYears" type="number" step="1" min="1" max="50" />
          </label>

          <label>
            Benefit duration (years)
            <input id="benefitYears" type="number" step="1" min="0" max="50" />
          </label>

          <label>
            Benefit decay per year (% of previous year)
            <input id="benefitDecay" type="number" step="1" min="0" max="100" />
            <span class="hint">100 = no decay, 90 = 10% smaller each year</span>
          </label>

          <label>
            Price (AUD per tonne)
            <input id="pricePerTonne" type="number" step="1" min="0" />
          </label>

          <label class="check">
            <input id="includeOpCost" type="checkbox" />
            Include annual operating cost difference (optional)
          </label>

          <label>
            Annual operating cost difference (AUD/ha/year)
            <input id="annualOpCost" type="number" step="1" />
            <span class="hint">Use this only if the treatment changes annual operating costs relative to control.</span>
          </label>
        </div>
        <div class="muted">
          Definitions: NPV = PV Benefits − PV Costs. BCR = PV Benefits ÷ PV Costs. ROI = NPV ÷ PV Costs.
        </div>
      </div>
    </section>

    <section id="tab-results" class="tab-panel">
      <div class="card">
        <div class="row">
          <h2>Results</h2>
          <div class="row-actions">
            <button class="btn" id="btnCopyResults" type="button" disabled>Copy table</button>
            <button class="btn primary" id="btnExportResults" type="button" disabled>Export Excel</button>
          </div>
        </div>
        <div id="resultsBox"></div>
      </div>
    </section>

    <section id="tab-sensitivity" class="tab-panel">
      <div id="sensitivityBox"></div>
    </section>

    <section id="tab-export" class="tab-panel">
      <div class="card">
        <h2>Export options</h2>
        <p>
          Use “Export Excel” on the Results tab to export a clean workbook containing the assumptions and the results table.
          Use “Copy table” to paste directly into Word.
        </p>
        <div class="callout">
          If you want to work Excel-first, download the template, fill it, then upload it back. The tool will detect the
          template and compute PV benefits and PV costs from your year-by-year inputs.
        </div>
      </div>
    </section>

    <section id="tab-help" class="tab-panel">
      <div class="card">
        <h2>How to use</h2>
        <ol class="steps">
          <li>Upload an Excel file (either your trial sheet or the template).</li>
          <li>Check the Data tab to confirm the control and treatment summaries look right.</li>
          <li>Set Assumptions (discount rate, horizon, price, and benefit duration).</li>
          <li>Click Run analysis.</li>
          <li>Copy the Results table into Word or export to Excel.</li>
        </ol>

        <h3>Common issues</h3>
        <p class="muted">
          If your trial spreadsheet has different header text, rename your columns to include “Amendment” and “Yield t/ha”.
          For costs, the tool prefers a column named “|” (as in the Lockhart file) or “Treatment Input Cost Only /Ha”.
        </p>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
