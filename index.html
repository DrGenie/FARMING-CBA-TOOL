<!-- index.html — Farming CBA Decision Tool 2 (upgraded) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farming CBA Decision Tool 2 - Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="application-name" content="Farming CBA Decision Tool 2" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-theme="worldbank-light">
  <div id="toast-root"></div>

  <header class="app-header">
    <div class="brand">
      <div class="brand-mark" aria-hidden="true">NBS</div>
      <div class="brand-text">
        <div class="brand-title">Farming CBA Decision Tool 2</div>
        <div class="brand-subtitle">Newcastle Business School</div>
      </div>
    </div>
    <div class="header-actions">
      <button id="startBtn" class="btn primary">Start with project setup</button>
      <button id="saveProject" class="btn ghost">Save project (JSON)</button>
      <button id="loadProject" class="btn ghost">Load project</button>
      <input type="file" id="loadFile" accept=".json" style="display:none" />
    </div>
  </header>

  <main class="app-main">
    <nav class="tabs-nav" aria-label="Main sections">
      <button type="button" class="tab-link active" data-tab="intro" aria-selected="true">Introduction</button>
      <button type="button" class="tab-link" data-tab="project">Project</button>
      <button type="button" class="tab-link" data-tab="settings">Time and risk settings</button>
      <button type="button" class="tab-link" data-tab="outputs">Outputs</button>
      <button type="button" class="tab-link" data-tab="treatments">Treatments</button>
      <button type="button" class="tab-link" data-tab="benefits">Additional benefits</button>
      <button type="button" class="tab-link" data-tab="costs">Other costs</button>
      <button type="button" class="tab-link" data-tab="database">Sources</button>
      <button type="button" class="tab-link" data-tab="results">Results</button>
      <button type="button" class="tab-link" data-tab="simulation">Simulation</button>
      <button type="button" class="tab-link" data-tab="excel">Excel import and export</button>
      <button type="button" class="tab-link" data-tab="copilot">AI interpretation helper</button>
      <button type="button" class="tab-link" data-tab="appendix">Technical appendix</button>
    </nav>

    <!-- INTRO TAB -->
    <section class="tab-panel active show" id="tab-intro" data-tab-panel="intro" aria-hidden="false">
      <div class="card">
        <h1>Farming CBA Decision Tool 2</h1>
        <p>
          This tool compares farm treatments against a defined control using standard cost benefit analysis
          metrics. It is designed for practical decision support and teaching: users can see the headline
          indicators immediately, then explore drivers and sensitivities without the tool prescribing a single choice.
        </p>
        <p>
          If you prefer Excel, use the Excel tab to download a template, fill in a small number of rows, and upload it back.
          The tool validates the workbook, applies it to the scenario, and updates results.
        </p>
        <div class="intro-actions">
          <button id="startBtn-duplicate" class="btn primary" data-tab-jump="project">Go to project setup</button>
          <button class="btn" data-tab-jump="excel">Excel-first workflow</button>
          <button class="btn" data-tab-jump="results">Jump to results</button>
        </div>
      </div>
    </section>

    <!-- PROJECT TAB -->
    <section class="tab-panel" id="tab-project" data-tab-panel="project" aria-hidden="true">
      <div class="card">
        <h2>Project description</h2>
        <div class="row-3">
          <div class="field">
            <label for="projectName" data-tooltip="Short title for the farm trial or investment project.">Project name</label>
            <input id="projectName" type="text" />
          </div>
          <div class="field">
            <label for="projectLead" data-tooltip="Person with overall responsibility for the project.">Project lead</label>
            <input id="projectLead" type="text" />
          </div>
          <div class="field">
            <label for="analystNames" data-tooltip="People who prepared the cost benefit analysis.">Analyst team</label>
            <input id="analystNames" type="text" />
          </div>
        </div>

        <div class="row-3">
          <div class="field">
            <label for="projectTeam" data-tooltip="Delivery partners or trial team involved in implementation.">Partners or trial team</label>
            <input id="projectTeam" type="text" />
          </div>
          <div class="field">
            <label for="organisation" data-tooltip="Host organisation for the analysis or project.">Organisation</label>
            <input id="organisation" type="text" />
          </div>
          <div class="field">
            <label for="lastUpdated" data-tooltip="Date when the analysis was last updated.">Last updated</label>
            <input id="lastUpdated" type="date" />
          </div>
        </div>

        <div class="row-3">
          <div class="field">
            <label for="contactEmail" data-tooltip="Contact email for questions about the analysis.">Contact email</label>
            <input id="contactEmail" type="email" />
          </div>
          <div class="field">
            <label for="contactPhone" data-tooltip="Optional phone contact for follow up.">Contact phone</label>
            <input id="contactPhone" type="tel" />
          </div>
          <div class="field"></div>
        </div>

        <div class="field">
          <label for="projectSummary" data-tooltip="Short plain language description of the project and trial.">Short summary</label>
          <textarea id="projectSummary" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="projectGoal" data-tooltip="Main goal in terms of production, profit, or risk reduction.">Project goal</label>
          <textarea id="projectGoal" rows="2"></textarea>
        </div>

        <div class="row-2">
          <div class="field">
            <label for="withProject" data-tooltip="What happens with the treatments or program in place.">With project (change story)</label>
            <textarea id="withProject" rows="3"></textarea>
          </div>
          <div class="field">
            <label for="withoutProject" data-tooltip="What happens under business as usual conditions.">Without project (baseline story)</label>
            <textarea id="withoutProject" rows="3"></textarea>
          </div>
        </div>

        <div class="field">
          <label for="projectObjectives" data-tooltip="Specific measurable objectives for the project.">Key objectives</label>
          <textarea id="projectObjectives" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="projectActivities" data-tooltip="Main activities that deliver the change (for example extension, training, soil treatments).">Main activities</label>
          <textarea id="projectActivities" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="stakeholderGroups" data-tooltip="Key stakeholder groups who gain, lose, or are involved.">Stakeholder groups</label>
          <textarea id="stakeholderGroups" rows="3"></textarea>
        </div>
      </div>
    </section>

    <!-- SETTINGS TAB -->
    <section class="tab-panel" id="tab-settings" data-tab-panel="settings" aria-hidden="true">
      <div class="card">
        <h2>Time horizon and discounting</h2>
        <div class="row-4">
          <div class="field">
            <label for="startYear" data-tooltip="Calendar year when the analysis starts (year 0 cashflows).">Analysis start year</label>
            <input id="startYear" type="number" />
          </div>
          <div class="field">
            <label for="projectStartYear" data-tooltip="Year when the project or treatments begin on farm.">Project start year</label>
            <input id="projectStartYear" type="number" />
          </div>
          <div class="field">
            <label for="years" data-tooltip="Number of years over which costs and benefits are counted.">Years of analysis</label>
            <input id="years" type="number" min="1" />
          </div>
          <div class="field">
            <label for="systemType" data-tooltip="Single farm analysis or roll out across multiple farms.">System type</label>
            <select id="systemType">
              <option value="single">Single farm or system</option>
              <option value="multiple">Multiple farms or systems</option>
            </select>
          </div>
        </div>

        <div class="row-4">
          <div class="field">
            <label for="discBase" data-tooltip="Central discount rate used for present value calculations.">Discount rate (base, percent)</label>
            <input id="discBase" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="discLow" data-tooltip="Lower bound for discount rate used in the simulation.">Discount rate (low, percent)</label>
            <input id="discLow" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="discHigh" data-tooltip="Upper bound for discount rate used in the simulation.">Discount rate (high, percent)</label>
            <input id="discHigh" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="outputAssumptions" data-tooltip="Any general assumptions about prices, yields, or trial design.">Notes on general assumptions</label>
            <textarea id="outputAssumptions" rows="2"></textarea>
          </div>
        </div>

        <div class="row-4">
          <div class="field">
            <label for="mirrFinance" data-tooltip="Finance rate used to discount negative cashflows in MIRR.">MIRR finance rate (percent)</label>
            <input id="mirrFinance" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="mirrReinvest" data-tooltip="Reinvestment rate applied to positive cashflows in MIRR.">MIRR reinvestment rate (percent)</label>
            <input id="mirrReinvest" type="number" step="0.1" />
          </div>
          <div class="field"></div>
          <div class="field"></div>
        </div>

        <h3>Discount schedule by period</h3>
        <p class="small muted">Adjust the low, base, and high discount rates used in the simulation for each period.</p>
        <div class="table-scroll">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Period</th>
                <th>Low (percent)</th>
                <th>Base (percent)</th>
                <th>High (percent)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>2025 to 2034</td>
                <td><input type="number" step="0.1" data-disc-period="0" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="0" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="0" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2035 to 2044</td>
                <td><input type="number" step="0.1" data-disc-period="1" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="1" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="1" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2045 to 2054</td>
                <td><input type="number" step="0.1" data-disc-period="2" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="2" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="2" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2055 to 2064</td>
                <td><input type="number" step="0.1" data-disc-period="3" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="3" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="3" data-scenario="high" /></td>
              </tr>
              <tr>
                <td>2065 to 2074</td>
                <td><input type="number" step="0.1" data-disc-period="4" data-scenario="low" /></td>
                <td><input type="number" step="0.1" data-disc-period="4" data-scenario="base" /></td>
                <td><input type="number" step="0.1" data-disc-period="4" data-scenario="high" /></td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3>Adoption settings</h3>
        <p class="small muted">
          These parameters control adoption multipliers applied to treatment benefits. Treatment areas are entered in the Treatments tab.
        </p>
        <div class="row-3">
          <div class="field">
            <label for="adoptLow" data-tooltip="Lower bound for the share of the target area that adopts the treatment.">Adoption low (multiplier)</label>
            <input id="adoptLow" type="number" step="0.05" min="0" max="1" />
          </div>
          <div class="field">
            <label for="adoptBase" data-tooltip="Central assumption for the share of the target area that adopts.">Adoption base (multiplier)</label>
            <input id="adoptBase" type="number" step="0.05" min="0" max="1" />
          </div>
          <div class="field">
            <label for="adoptHigh" data-tooltip="Upper bound for the share of the target area that adopts.">Adoption high (multiplier)</label>
            <input id="adoptHigh" type="number" step="0.05" min="0" max="1" />
          </div>
        </div>

        <h3>Risk settings</h3>
        <div class="row-3">
          <div class="field">
            <label for="riskLow" data-tooltip="Lower bound for overall risk that benefits are not fully realised.">Overall risk low</label>
            <input id="riskLow" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="riskBase" data-tooltip="Central estimate of overall risk that reduces effective benefits.">Overall risk base</label>
            <input id="riskBase" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="riskHigh" data-tooltip="Upper bound for overall risk that reduces effective benefits.">Overall risk high</label>
            <input id="riskHigh" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>

        <p class="small muted">You can also build the base risk from component risks below.</p>
        <div class="row-5">
          <div class="field">
            <label for="rTech" data-tooltip="Risk that the technical performance of the treatment is lower than expected.">Technical risk</label>
            <input id="rTech" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rNonCoop" data-tooltip="Risk that farmers or partners do not cooperate or maintain practices.">Non cooperation risk</label>
            <input id="rNonCoop" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rSocio" data-tooltip="Social or institutional risks that limit implementation.">Social risk</label>
            <input id="rSocio" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rFin" data-tooltip="Financial risks such as budget cuts or price changes.">Financial risk</label>
            <input id="rFin" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="rMan" data-tooltip="Management risks including planning, staffing, and coordination.">Management risk</label>
            <input id="rMan" type="number" step="0.01" min="0" max="1" />
          </div>
        </div>
        <div class="row-2">
          <div class="field">
            <button id="calcCombinedRisk" class="btn">Calculate combined base risk</button>
          </div>
          <div class="field">
            <div id="combinedRiskOut" class="metric" data-tooltip="Combined risk derived from the component risks above.">
              <div class="label">Combined risk</div>
              <div class="value small muted">Not calculated yet</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- OUTPUTS TAB -->
    <section class="tab-panel" id="tab-outputs" data-tab-panel="outputs" aria-hidden="true">
      <div class="card">
        <h2>Outputs and valuation</h2>
        <p>
          Outputs describe the production changes per hectare (or per unit). Assign a monetary value per unit to link them to benefits.
          If you prefer Excel, you can manage outputs in the workbook and upload it back.
        </p>
        <div class="toolbar">
          <button id="addOutput" class="btn small">Add output</button>
        </div>
        <div id="outputsList" class="item-list"></div>
      </div>
    </section>

    <!-- TREATMENTS TAB -->
    <section class="tab-panel" id="tab-treatments" data-tab-panel="treatments" aria-hidden="true">
      <div class="card">
        <h2>Treatments and control</h2>
        <p>
          Each treatment represents a defined practice applied to a given area. Choose exactly one control to act as the baseline comparator.
          The Results tab shows a clean table with indicators as rows and treatments (including the control) as columns.
        </p>
        <div class="toolbar">
          <button id="addTreatment" class="btn small">Add treatment</button>
        </div>
        <div id="treatmentsList" class="item-list"></div>
      </div>
    </section>

    <!-- BENEFITS TAB -->
    <section class="tab-panel" id="tab-benefits" data-tab-panel="benefits" aria-hidden="true">
      <div class="card">
        <h2>Additional benefits</h2>
        <p>Use this section for cost savings, avoided losses, risk reduction, and asset value changes not already captured in treatment outputs.</p>
        <div class="toolbar">
          <button id="addBenefit" class="btn small">Add benefit</button>
        </div>
        <div id="benefitsList" class="item-list"></div>
      </div>
    </section>

    <!-- COSTS TAB -->
    <section class="tab-panel" id="tab-costs" data-tab-panel="costs" aria-hidden="true">
      <div class="card">
        <h2>Other project costs</h2>
        <p>Enter project management, monitoring, extension, or other aggregated costs here. Treatment-level costs are handled in the Treatments tab.</p>
        <div class="toolbar">
          <button id="addCost" class="btn small">Add cost item</button>
        </div>
        <div id="costsList" class="item-list"></div>
      </div>
    </section>

    <!-- DATABASE TAB -->
    <section class="tab-panel" id="tab-database" data-tab-panel="database" aria-hidden="true">
      <div class="card">
        <h2>Sources and database tagging</h2>
        <p class="small muted">Record data sources for later auditability or evidence registers. This supports transparency without adding complexity to results.</p>
        <h3>Outputs</h3>
        <div id="dbOutputs" class="item-list"></div>
        <h3>Treatments</h3>
        <div id="dbTreatments" class="item-list"></div>
      </div>
    </section>

    <!-- RESULTS TAB -->
    <section class="tab-panel" id="tab-results" data-tab-panel="results" aria-hidden="true">
      <div class="card">
        <div class="results-header">
          <h2>Economic results</h2>
          <div class="results-actions">
            <button id="recalc" class="btn primary" data-action="recalc">Recalculate results</button>
            <button id="exportXlsx" class="btn">Export Excel</button>
            <button id="exportCsv" class="btn ghost">Export CSV</button>
            <button id="exportPdf" class="btn ghost">Print or export PDF</button>
          </div>
        </div>

        <div class="card subtle">
          <div class="row-3">
            <div class="field">
              <label for="rankMetric" data-tooltip="Ranking is shown in the comparison table. Choose the basis that best fits your decision context.">Ranking basis</label>
              <select id="rankMetric">
                <option value="bcr">Benefit–cost ratio (BCR)</option>
                <option value="npv">Net present value (NPV)</option>
                <option value="roi">Return on investment (ROI)</option>
              </select>
            </div>
            <div class="field">
              <label for="showDeltas" data-tooltip="Adds extra rows showing differences relative to the control (teaching view).">Teaching view</label>
              <select id="showDeltas">
                <option value="false">Off (snapshot only)</option>
                <option value="true">On (show deltas vs control)</option>
              </select>
            </div>
            <div class="field">
              <label for="treatPageSize" data-tooltip="If you have many treatments, the table can be paged for easier reading. Exports always include all treatments.">Treatments per view</label>
              <select id="treatPageSize">
                <option value="6">6</option>
                <option value="8" selected>8</option>
                <option value="10">10</option>
                <option value="12">12</option>
                <option value="999">All</option>
              </select>
            </div>
          </div>

          <div class="row-2 align-center">
            <div class="field">
              <div class="small muted" id="compareStatus">Ready.</div>
            </div>
            <div class="field right">
              <button id="prevTreatPage" class="btn small">Prev</button>
              <button id="nextTreatPage" class="btn small">Next</button>
            </div>
          </div>

          <h3>Treatment comparison against control (base case)</h3>
          <p class="small muted">
            Indicators are rows and treatments are columns. The control appears alongside all treatments for direct comparison.
            Values use the base discount rate, base adoption, and base risk settings.
          </p>
          <div class="table-scroll">
            <table id="treatCompareTable" class="compare-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="small muted">
            Tip: export to Excel for easy sharing, Word tables, and further sensitivity calculations in a familiar workflow.
          </div>
        </div>

        <details class="details">
          <summary>Project-wide summary (optional)</summary>
          <div class="details-inner">
            <h3>Whole project summary (base case)</h3>
            <div class="row-4 metrics-grid">
              <div class="field">
                <label data-tooltip="Present value of all benefits across the analysis period using the base discount rate.">Present value of benefits</label>
                <div class="metric"><div id="pvBenefits" class="value">0</div><div class="label">All benefits, discounted</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Present value of all costs across the analysis period using the base discount rate.">Present value of costs</label>
                <div class="metric"><div id="pvCosts" class="value">0</div><div class="label">All costs, discounted</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Present value of benefits minus present value of costs.">Net present value</label>
                <div class="metric"><div id="npv" class="value">0</div><div class="label">Benefits minus costs</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Present value of benefits divided by present value of costs. Values greater than 1 indicate that benefits exceed costs.">Benefit cost ratio</label>
                <div class="metric"><div id="bcr" class="value">0</div><div class="label">PV benefits divided by PV costs</div></div>
              </div>
            </div>

            <div class="row-4 metrics-grid">
              <div class="field">
                <label data-tooltip="Discount rate at which the net present value is equal to zero.">Internal rate of return</label>
                <div class="metric"><div id="irr" class="value">0</div><div class="label">Percent return solving NPV equal to zero</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Rate of return calculated using separate finance and reinvestment rates.">Modified internal rate of return</label>
                <div class="metric"><div id="mirr" class="value">0</div><div class="label">Uses finance and reinvestment rates</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Net present value expressed as a percentage of the present value of costs.">Return on investment</label>
                <div class="metric"><div id="roi" class="value">0</div><div class="label">NPV relative to PV of costs</div></div>
              </div>
              <div class="field">
                <label data-tooltip="Number of years for the discounted net benefits to first turn positive.">Payback period</label>
                <div class="metric"><div id="payback" class="value">0</div><div class="label">Discounted time to recover costs</div></div>
              </div>
            </div>
          </div>
        </details>

        <details class="details">
          <summary>NPV by analysis horizon (optional)</summary>
          <div class="details-inner">
            <div class="row-2">
              <div class="field">
                <div class="table-scroll">
                  <table id="timeProjectionTable" class="summary-table">
                    <thead>
                      <tr>
                        <th data-tooltip="Number of years included in the partial analysis.">Years</th>
                        <th data-tooltip="Present value of benefits for the given analysis horizon.">PV benefits</th>
                        <th data-tooltip="Present value of costs for the given analysis horizon.">PV costs</th>
                        <th data-tooltip="Net present value for the given analysis horizon.">NPV</th>
                        <th data-tooltip="Benefit cost ratio for the given analysis horizon.">BCR</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div class="field">
                <canvas id="timeNpvChart" width="480" height="260" data-tooltip="Line chart of net present value against analysis horizon."></canvas>
              </div>
            </div>
          </div>
        </details>

        <div class="results-footer">
          <button id="exportXlsxFoot" class="btn">Export Excel</button>
          <button id="exportCsvFoot" class="btn ghost">Export CSV</button>
          <button id="exportPdfFoot" class="btn ghost">Print or PDF</button>
        </div>
      </div>
    </section>

    <!-- SIMULATION TAB -->
    <section class="tab-panel" id="tab-simulation" data-tab-panel="simulation" aria-hidden="true">
      <div class="card">
        <div class="results-header">
          <h2>Monte Carlo simulation</h2>
          <button id="runSim" class="btn primary" data-action="run-sim">Run simulation</button>
        </div>

        <p class="small muted">
          The simulation varies discount rates, adoption, risk, and optional input variation. This helps you understand whether
          a treatment’s ranking is robust to uncertainty.
        </p>

        <div class="row-4">
          <div class="field">
            <label for="simN" data-tooltip="Number of random draws used in the Monte Carlo simulation. Larger values give smoother results but take longer.">Number of runs</label>
            <input id="simN" type="number" min="100" step="100" />
          </div>
          <div class="field">
            <label for="targetBCR" data-tooltip="Optional target BCR for reporting probabilities. The tool does not treat this as a rule.">Target BCR for reporting</label>
            <input id="targetBCR" type="number" step="0.1" min="0" />
            <div class="small muted">Current target: <span id="simBcrTargetLabel">2</span></div>
          </div>
          <div class="field">
            <label for="bcrMode" data-tooltip="Choice of whether the benefit cost ratio divides by all costs or only constrained costs.">BCR denominator</label>
            <select id="bcrMode">
              <option value="all">All costs</option>
              <option value="constrained">Constrained costs only</option>
            </select>
          </div>
          <div class="field">
            <label for="randSeed" data-tooltip="Optional random seed to reproduce the same simulation results. Leave blank for a different draw each time.">Random seed (optional)</label>
            <input id="randSeed" type="number" />
          </div>
        </div>

        <h3>Variation settings</h3>
        <div class="row-4">
          <div class="field">
            <label for="simVarPct" data-tooltip="Size of random variation applied to selected inputs, expressed as a percentage.">Variation size (percent)</label>
            <input id="simVarPct" type="number" step="1" min="0" max="100" />
          </div>
          <div class="field">
            <label for="simVaryOutputs" data-tooltip="If yes, output values are randomly varied within the chosen range.">Vary output values</label>
            <select id="simVaryOutputs">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="field">
            <label for="simVaryTreatCosts" data-tooltip="If yes, treatment costs are randomly varied within the chosen range.">Vary treatment costs</label>
            <select id="simVaryTreatCosts">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          <div class="field">
            <label for="simVaryInputCosts" data-tooltip="If yes, other project costs are randomly varied within the chosen range.">Vary other project costs</label>
            <select id="simVaryInputCosts">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>

        <div class="field"><div id="simStatus" class="small muted">Simulation not run yet.</div></div>

        <hr />

        <h3>Simulation summary (project-wide)</h3>
        <div class="row-2">
          <div class="card subtle">
            <h4>Net present value</h4>
            <div class="row-4 metrics-grid">
              <div class="field"><label>Minimum</label><div class="metric"><div id="simNpvMin" class="value">n/a</div></div></div>
              <div class="field"><label>Maximum</label><div class="metric"><div id="simNpvMax" class="value">n/a</div></div></div>
              <div class="field"><label>Mean</label><div class="metric"><div id="simNpvMean" class="value">n/a</div></div></div>
              <div class="field"><label>Median</label><div class="metric"><div id="simNpvMedian" class="value">n/a</div></div></div>
            </div>
            <div class="row-2 metrics-grid">
              <div class="field"><label>Probability NPV &gt; 0</label><div class="metric"><div id="simNpvProb" class="value">n/a</div></div></div>
            </div>
          </div>

          <div class="card subtle">
            <h4>Benefit cost ratio</h4>
            <div class="row-4 metrics-grid">
              <div class="field"><label>Minimum</label><div class="metric"><div id="simBcrMin" class="value">n/a</div></div></div>
              <div class="field"><label>Maximum</label><div class="metric"><div id="simBcrMax" class="value">n/a</div></div></div>
              <div class="field"><label>Mean</label><div class="metric"><div id="simBcrMean" class="value">n/a</div></div></div>
              <div class="field"><label>Median</label><div class="metric"><div id="simBcrMedian" class="value">n/a</div></div></div>
            </div>
            <div class="row-3 metrics-grid">
              <div class="field"><label>Probability BCR &gt; 1</label><div class="metric"><div id="simBcrProb1" class="value">n/a</div></div></div>
              <div class="field"><label>Probability BCR &gt; target</label><div class="metric"><div id="simBcrProbTarget" class="value">n/a</div></div></div>
              <div class="field"></div>
            </div>
          </div>
        </div>

        <hr />

        <h3>Distributions</h3>
        <div class="row-2">
          <div class="field"><canvas id="histNpv" width="480" height="260" data-tooltip="Histogram of simulated net present value."></canvas></div>
          <div class="field"><canvas id="histBcr" width="480" height="260" data-tooltip="Histogram of simulated benefit cost ratio."></canvas></div>
        </div>
      </div>
    </section>

    <!-- EXCEL TAB -->
    <section class="tab-panel" id="tab-excel" data-tab-panel="excel" aria-hidden="true">
      <div class="card">
        <h2>Excel import and export</h2>
        <p>
          Excel-first workflow: download a template, enter or modify a small number of rows, save, and upload it back.
          The tool validates the workbook structure, applies it to the scenario, and updates results.
        </p>

        <div class="row-2">
          <div class="field">
            <h3>Templates</h3>
            <button id="downloadTemplate" class="btn">Download blank template</button>
            <button id="downloadSample" class="btn ghost">Download template pre-filled with current scenario</button>
            <div class="small muted">
              The template includes clear sheet names and column headers. Keep the sheet names unchanged for reliable import.
            </div>
          </div>
          <div class="field">
            <h3>Import from Excel</h3>
            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" />
            <div class="row-2">
              <button id="chooseExcel" class="btn">Choose Excel file</button>
              <button id="parseExcel" class="btn ghost">Parse and validate</button>
            </div>
            <div class="row-2">
              <button id="importExcel" class="btn primary">Apply parsed Excel data to the model</button>
              <button id="clearParsedExcel" class="btn ghost">Clear parsed data</button>
            </div>

            <div class="small muted" id="excelStatus">No Excel file selected.</div>
            <textarea id="excelPreview" class="mono" rows="10" readonly placeholder="Parsed workbook preview will appear here."></textarea>
          </div>
        </div>

        <p class="small muted">
          Excel import and export rely on the SheetJS XLSX library loaded in the page. If the library is missing, the tool will prompt you.
        </p>
      </div>
    </section>

    <!-- AI HELPER TAB -->
    <section class="tab-panel" id="tab-copilot" data-tab-panel="copilot" aria-hidden="true">
      <div class="card">
        <h2>AI interpretation helper</h2>
        <p>
          This tab prepares a structured prompt you can paste into any large language model (Copilot, ChatGPT, etc.).
          The prompt requests a plain-English interpretation of the CBA results, explains key indicators, highlights trade-offs,
          and suggests practical improvement options for underperforming treatments without dictating decisions.
        </p>

        <div class="row-2">
          <div class="field">
            <div class="row-2">
              <button id="copyAiPrompt" class="btn primary">Copy AI interpretation prompt</button>
              <button id="refreshAiPrompt" class="btn ghost">Refresh prompt</button>
            </div>
            <div class="small muted">
              Paste the copied prompt into your preferred assistant. The tool does not send data anywhere; copying is local to your browser.
            </div>

            <h3 class="mt">Optional prompt settings</h3>
            <div class="row-3">
              <div class="field">
                <label for="aiTone">Writing style</label>
                <select id="aiTone">
                  <option value="plain" selected>Plain English (farmer-friendly)</option>
                  <option value="extension">Extension note (practical)</option>
                  <option value="policy">Policy note (decision-maker)</option>
                </select>
              </div>
              <div class="field">
                <label for="aiLength">Length</label>
                <select id="aiLength">
                  <option value="short" selected>Short (about 200–350 words)</option>
                  <option value="medium">Medium (about 400–700 words)</option>
                  <option value="long">Long (about 900–1,300 words)</option>
                </select>
              </div>
              <div class="field">
                <label for="aiIncludeTeach">Include teaching explanations</label>
                <select id="aiIncludeTeach">
                  <option value="true" selected>Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label for="copilotPreview" data-tooltip="This is the prompt that will be copied.">Prompt preview</label>
            <textarea id="copilotPreview" rows="18" readonly class="mono"></textarea>
          </div>
        </div>
      </div>
    </section>

    <!-- TECHNICAL APPENDIX TAB -->
    <section class="tab-panel" id="tab-appendix" data-tab-panel="appendix" aria-hidden="true">
      <div class="card">
        <h2>Technical appendix and user guide</h2>
        <p>
          The appendix describes formulas, indicator definitions, and step-by-step guidance for both non-technical and technical users.
        </p>
        <div class="row-2">
          <div class="field">
            <button type="button" class="btn primary" onclick="window.open('technical-appendix.html','_blank','noopener');">
              Open full technical appendix
            </button>
            <p class="small muted">Opens the appendix in a new tab so you can keep your scenario open here.</p>
          </div>
          <div class="field">
            <label class="small muted">If the button does not work, use this link.</label>
            <a href="technical-appendix.html" target="_blank" rel="noopener" class="small">Open technical-appendix.html in a new tab</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <div class="footer-left">
      <span class="small muted">Farming CBA Decision Tool 2, Newcastle Business School</span>
    </div>
    <div class="footer-right">
      <button id="exportXlsxFoot2" class="btn small">Export Excel</button>
      <button id="exportCsvFoot2" class="btn small ghost">Export CSV</button>
      <button id="exportPdfFoot2" class="btn small ghost">Print or PDF</button>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
