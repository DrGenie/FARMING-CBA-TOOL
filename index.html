<!-- index.htmll -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farming CBA Decision Tool 2 – Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body data-theme="worldbank-light">
  <div id="toast-root" aria-live="polite" aria-atomic="true"></div>

  <header class="app-header">
    <div class="brand">
      <div class="brand-mark" aria-hidden="true">NBS</div>
      <div class="brand-text">
        <div class="brand-title">Farming CBA Decision Tool 2</div>
        <div class="brand-subtitle">Newcastle Business School</div>
      </div>
    </div>

    <div class="header-actions">
      <button id="startBtn" class="btn primary">Start with project setup</button>
      <button id="saveProject" class="btn ghost">Save project (JSON)</button>
      <button id="loadProject" class="btn ghost">Load project</button>
      <input type="file" id="loadFile" accept=".json" style="display:none" />
    </div>
  </header>

  <main class="app-main">
    <nav class="tabs-nav" aria-label="Main sections">
      <button type="button" class="tab-link active" data-tab="intro" aria-selected="true">Introduction</button>
      <button type="button" class="tab-link" data-tab="project">Project</button>
      <button type="button" class="tab-link" data-tab="settings">Time and risk settings</button>
      <button type="button" class="tab-link" data-tab="outputs">Outputs</button>
      <button type="button" class="tab-link" data-tab="treatments">Treatments</button>
      <button type="button" class="tab-link" data-tab="benefits">Additional benefits</button>
      <button type="button" class="tab-link" data-tab="costs">Other costs</button>
      <button type="button" class="tab-link" data-tab="sources">Sources</button>
      <button type="button" class="tab-link" data-tab="results">Results</button>
      <button type="button" class="tab-link" data-tab="simulation">Simulation</button>
      <button type="button" class="tab-link" data-tab="excel">Excel import and export</button>
      <button type="button" class="tab-link" data-tab="ai">AI interpretation</button>
      <button type="button" class="tab-link" data-tab="appendix">Technical appendix</button>
    </nav>

    <!-- INTRO TAB -->
    <section class="tab-panel active show" id="tab-intro" data-tab-panel="intro" aria-hidden="false">
      <div class="card">
        <h1>Farming CBA Decision Tool 2</h1>
        <p>
          This decision support tool compares farm treatments against a control using standard cost benefit analysis indicators.
          The default scenario is a faba bean soil amendment trial dataset (2022). You can keep it as a worked example or
          replace it using the Excel-first workflow.
        </p>
        <p>
          The Results tab gives a snapshot comparison (vertical table: indicators as rows, treatments as columns). Detailed
          notes are optional and secondary to headline metrics.
        </p>
        <div class="intro-actions">
          <button id="startBtn-duplicate" class="btn primary" data-tab-jump="project">Go to project setup</button>
          <button class="btn" data-tab-jump="excel">Excel workflow</button>
          <button class="btn" data-tab-jump="results">Jump to results</button>
        </div>
      </div>
    </section>

    <!-- PROJECT TAB -->
    <section class="tab-panel" id="tab-project" data-tab-panel="project" aria-hidden="true">
      <div class="card">
        <h2>Project description</h2>

        <div class="row-3">
          <div class="field">
            <label for="projectName">Project name <span class="tip" data-tip="Short title for the farm trial or investment project.">?</span></label>
            <input id="projectName" type="text" />
          </div>
          <div class="field">
            <label for="projectLead">Project lead <span class="tip" data-tip="Person with overall responsibility for the project.">?</span></label>
            <input id="projectLead" type="text" />
          </div>
          <div class="field">
            <label for="analystNames">Analyst team <span class="tip" data-tip="People who prepared the cost benefit analysis.">?</span></label>
            <input id="analystNames" type="text" />
          </div>
        </div>

        <div class="row-3">
          <div class="field">
            <label for="projectTeam">Partners or trial team <span class="tip" data-tip="Delivery partners or trial team involved in implementation.">?</span></label>
            <input id="projectTeam" type="text" />
          </div>
          <div class="field">
            <label for="organisation">Organisation <span class="tip" data-tip="Host organisation for the analysis or project.">?</span></label>
            <input id="organisation" type="text" />
          </div>
          <div class="field">
            <label for="lastUpdated">Last updated <span class="tip" data-tip="Date when the analysis was last updated.">?</span></label>
            <input id="lastUpdated" type="date" />
          </div>
        </div>

        <div class="row-3">
          <div class="field">
            <label for="contactEmail">Contact email <span class="tip" data-tip="Contact email for questions about the analysis.">?</span></label>
            <input id="contactEmail" type="email" />
          </div>
          <div class="field">
            <label for="contactPhone">Contact phone <span class="tip" data-tip="Optional phone contact for follow up.">?</span></label>
            <input id="contactPhone" type="tel" />
          </div>
          <div class="field"></div>
        </div>

        <div class="field">
          <label for="projectSummary">Short summary <span class="tip" data-tip="Short plain language description of the project and trial.">?</span></label>
          <textarea id="projectSummary" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="projectGoal">Project goal <span class="tip" data-tip="Main goal in terms of production, profit, or risk reduction.">?</span></label>
          <textarea id="projectGoal" rows="2"></textarea>
        </div>

        <div class="row-2">
          <div class="field">
            <label for="withProject">With project (change story) <span class="tip" data-tip="What happens with the treatments or program in place.">?</span></label>
            <textarea id="withProject" rows="3"></textarea>
          </div>
          <div class="field">
            <label for="withoutProject">Without project (baseline story) <span class="tip" data-tip="What happens under business-as-usual conditions.">?</span></label>
            <textarea id="withoutProject" rows="3"></textarea>
          </div>
        </div>

        <div class="field">
          <label for="projectObjectives">Key objectives <span class="tip" data-tip="Specific measurable objectives for the project.">?</span></label>
          <textarea id="projectObjectives" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="projectActivities">Main activities <span class="tip" data-tip="Main activities that deliver the change (for example extension, training, soil treatments).">?</span></label>
          <textarea id="projectActivities" rows="3"></textarea>
        </div>

        <div class="field">
          <label for="stakeholderGroups">Stakeholder groups <span class="tip" data-tip="Key stakeholder groups who gain, lose, or are involved.">?</span></label>
          <textarea id="stakeholderGroups" rows="3"></textarea>
        </div>
      </div>
    </section>

    <!-- SETTINGS TAB -->
    <section class="tab-panel" id="tab-settings" data-tab-panel="settings" aria-hidden="true">
      <div class="card">
        <h2>Time horizon and discounting</h2>

        <div class="row-4">
          <div class="field">
            <label for="startYear">Analysis start year <span class="tip" data-tip="Calendar year when the analysis starts (year 0 cashflows).">?</span></label>
            <input id="startYear" type="number" />
          </div>
          <div class="field">
            <label for="projectStartYear">Project start year <span class="tip" data-tip="Year when the project or treatments begin on farm.">?</span></label>
            <input id="projectStartYear" type="number" />
          </div>
          <div class="field">
            <label for="years">Years of analysis <span class="tip" data-tip="Number of years over which costs and benefits are counted.">?</span></label>
            <input id="years" type="number" min="1" />
          </div>
          <div class="field">
            <label for="systemType">System type <span class="tip" data-tip="Single farm analysis or roll out across multiple farms.">?</span></label>
            <select id="systemType">
              <option value="single">Single farm or system</option>
              <option value="multiple">Multiple farms or systems</option>
            </select>
          </div>
        </div>

        <div class="row-4">
          <div class="field">
            <label for="discBase">Discount rate (base, %) <span class="tip" data-tip="Central discount rate used for present value calculations.">?</span></label>
            <input id="discBase" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="discLow">Discount rate (low, %) <span class="tip" data-tip="Lower bound for discount rate used in simulation.">?</span></label>
            <input id="discLow" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="discHigh">Discount rate (high, %) <span class="tip" data-tip="Upper bound for discount rate used in simulation.">?</span></label>
            <input id="discHigh" type="number" step="0.1" />
          </div>
          <div class="field">
            <label for="outputAssumptions">Notes on general assumptions <span class="tip" data-tip="Any general assumptions about prices, yields, or trial design.">?</span></label>
            <textarea id="outputAssumptions" rows="2"></textarea>
          </div>
        </div>

        <h3>Adoption and risk</h3>
        <div class="row-3">
          <div class="field">
            <label for="adoptBase">Adoption (base) <span class="tip" data-tip="Share of target area that adopts the treatment (applied as a multiplier).">?</span></label>
            <input id="adoptBase" type="number" step="0.05" min="0" max="1" />
          </div>
          <div class="field">
            <label for="riskBase">Overall risk (base) <span class="tip" data-tip="Reduces effective benefits: effective benefits = benefits × (1 − risk).">?</span></label>
            <input id="riskBase" type="number" step="0.01" min="0" max="1" />
          </div>
          <div class="field">
            <label for="riskNotes">Risk notes <span class="tip" data-tip="Optional notes about the risk assumption.">?</span></label>
            <input id="riskNotes" type="text" />
          </div>
        </div>

        <p class="small muted">
          The Results tab uses the base discount rate, adoption, and risk. The Simulation tab varies assumptions within ranges.
        </p>
      </div>
    </section>

    <!-- OUTPUTS TAB -->
    <section class="tab-panel" id="tab-outputs" data-tab-panel="outputs" aria-hidden="true">
      <div class="card">
        <div class="card-head">
          <h2>Outputs and valuation</h2>
          <div class="toolbar">
            <button id="addOutput" class="btn small">Add output</button>
          </div>
        </div>
        <p class="small muted">
          Outputs define what changes on farm (for example yield). Values are the monetary value per unit.
        </p>
        <div id="outputsList" class="item-list"></div>
      </div>
    </section>

    <!-- TREATMENTS TAB -->
    <section class="tab-panel" id="tab-treatments" data-tab-panel="treatments" aria-hidden="true">
      <div class="card">
        <div class="card-head">
          <h2>Treatments and control</h2>
          <div class="toolbar">
            <button id="resetDefaultData" class="btn ghost small">Reload default faba bean dataset (2022)</button>
            <button id="addTreatment" class="btn small">Add treatment</button>
          </div>
        </div>
        <p class="small muted">
          One treatment must be flagged as the control. Results are reported as incremental outcomes relative to the control,
          with the control shown alongside all treatments.
        </p>
        <div id="treatmentsList" class="item-list"></div>
      </div>
    </section>

    <!-- BENEFITS TAB -->
    <section class="tab-panel" id="tab-benefits" data-tab-panel="benefits" aria-hidden="true">
      <div class="card">
        <div class="card-head">
          <h2>Additional benefits</h2>
          <div class="toolbar">
            <button id="addBenefit" class="btn small">Add benefit</button>
          </div>
        </div>
        <p class="small muted">
          Use this section for benefits not captured by outputs (for example cost savings, avoided losses, soil asset uplift).
        </p>
        <div id="benefitsList" class="item-list"></div>
      </div>
    </section>

    <!-- COSTS TAB -->
    <section class="tab-panel" id="tab-costs" data-tab-panel="costs" aria-hidden="true">
      <div class="card">
        <div class="card-head">
          <h2>Other project costs</h2>
          <div class="toolbar">
            <button id="addCost" class="btn small">Add cost item</button>
          </div>
        </div>
        <p class="small muted">
          Project-level costs (management, monitoring, extension). Treatment-level costs belong in the Treatments tab.
        </p>
        <div id="costsList" class="item-list"></div>
      </div>
    </section>

    <!-- SOURCES TAB -->
    <section class="tab-panel" id="tab-sources" data-tab-panel="sources" aria-hidden="true">
      <div class="card">
        <h2>Sources</h2>
        <p class="small muted">
          Record evidence sources used to populate outputs and costs.
        </p>
        <div id="sourcesList" class="item-list"></div>
      </div>
    </section>

    <!-- RESULTS TAB -->
    <section class="tab-panel" id="tab-results" data-tab-panel="results" aria-hidden="true">
      <div class="card">
        <div class="results-header">
          <h2>Results (snapshot)</h2>
          <div class="toolbar">
            <button id="recalc" class="btn primary">Recalculate</button>
            <button id="copyResultsTable" class="btn">Copy table</button>
            <button id="exportExcel" class="btn">Export Excel</button>
            <button id="exportPdf" class="btn ghost">Print or export PDF</button>
          </div>
        </div>

        <div class="callout">
          <div class="callout-title">What this view shows</div>
          <div class="callout-body">
            All treatments are compared against the control. Indicators are rows and treatments are columns.
            This table is designed for copy-paste into Word and export to Excel.
          </div>
        </div>

        <div class="results-controls">
          <div class="seg">
            <button id="viewIncremental" class="seg-btn active" type="button">Incremental vs control</button>
            <button id="viewAbsolute" class="seg-btn" type="button">Absolute (each option)</button>
          </div>
          <div class="pager">
            <button id="colPrev" class="btn small ghost" type="button">◀</button>
            <div class="small muted"><span id="colPageLabel">1</span></div>
            <button id="colNext" class="btn small ghost" type="button">▶</button>
          </div>
        </div>

        <div class="table-scroll" id="resultsMatrixWrap">
          <table id="resultsMatrix" class="matrix-table" aria-label="Treatment comparison matrix">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>

        <details class="details">
          <summary>Show driver summary (why results look like this)</summary>
          <div id="driverSummary" class="prose small"></div>
        </details>

        <details class="details">
          <summary>Show definitions of indicators</summary>
          <div class="prose small" id="indicatorDefinitions"></div>
        </details>

        <div class="results-footer">
          <button id="goAi" class="btn primary" data-tab-jump="ai">Open AI interpretation helper</button>
        </div>
      </div>
    </section>

    <!-- SIMULATION TAB -->
    <section class="tab-panel" id="tab-simulation" data-tab-panel="simulation" aria-hidden="true">
      <div class="card">
        <div class="results-header">
          <h2>Simulation</h2>
          <div class="toolbar">
            <button id="runSim" class="btn primary">Run simulation</button>
          </div>
        </div>
        <p class="small muted">
          The simulation varies discount rate, adoption, risk, and selected inputs. Use it to explore uncertainty, not to hide low performers.
        </p>

        <div class="row-4">
          <div class="field">
            <label for="simN">Number of runs <span class="tip" data-tip="Larger values are smoother but take longer.">?</span></label>
            <input id="simN" type="number" min="100" step="100" />
          </div>
          <div class="field">
            <label for="simVarPct">Variation size (%) <span class="tip" data-tip="Random variation applied to selected inputs.">?</span></label>
            <input id="simVarPct" type="number" min="0" step="1" />
          </div>
          <div class="field">
            <label for="simTargetBcr">Target BCR (for summary only) <span class="tip" data-tip="Used only for reporting probabilities; does not exclude treatments.">?</span></label>
            <input id="simTargetBcr" type="number" step="0.1" min="0" />
          </div>
          <div class="field">
            <label for="simSeed">Random seed (optional) <span class="tip" data-tip="Set to reproduce the same random draw.">?</span></label>
            <input id="simSeed" type="number" />
          </div>
        </div>

        <div class="row-2">
          <div class="field">
            <div id="simStatus" class="small muted">Simulation not run yet.</div>
            <div class="table-scroll">
              <table id="simSummaryTable" class="summary-table">
                <thead>
                  <tr>
                    <th>Treatment</th>
                    <th>Prob(NPV &gt; 0)</th>
                    <th>Prob(BCR &gt; 1)</th>
                    <th>Prob(BCR &gt; target)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="field">
            <canvas id="simChart" width="520" height="300"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- EXCEL TAB -->
    <section class="tab-panel" id="tab-excel" data-tab-panel="excel" aria-hidden="true">
      <div class="card">
        <h2>Excel-first workflow</h2>

        <div class="callout">
          <div class="callout-title">Plain-language workflow</div>
          <div class="callout-body">
            Download a template (blank or scenario-specific), edit rows in Excel, save the file, then upload it here.
            The tool validates the workbook, applies the data, and updates results automatically.
          </div>
        </div>

        <div class="row-2">
          <div class="field">
            <h3>Download</h3>
            <button id="downloadTemplate" class="btn">Download blank template</button>
            <button id="downloadScenarioTemplate" class="btn ghost">Download template for current scenario</button>
            <p class="small muted">
              The scenario template includes your current treatments, outputs, and settings.
            </p>
          </div>

          <div class="field">
            <h3>Upload and apply</h3>
            <input type="file" id="excelFile" accept=".xlsx,.xls" />
            <div class="toolbar" style="margin-top:10px">
              <button id="importExcel" class="btn primary">Validate and import</button>
              <button id="downloadImportReport" class="btn ghost" disabled>Download import report</button>
            </div>
            <div id="excelStatus" class="small muted" style="margin-top:8px">No file selected.</div>
            <div id="excelIssues" class="issues"></div>
          </div>
        </div>

        <details class="details">
          <summary>Template structure (what the tool expects)</summary>
          <div class="prose small" id="excelGuide"></div>
        </details>

        <p class="small muted">
          Excel features require the SheetJS XLSX library (already loaded on this page).
        </p>
      </div>
    </section>

    <!-- AI TAB -->
    <section class="tab-panel" id="tab-ai" data-tab-panel="ai" aria-hidden="true">
      <div class="card">
        <div class="card-head">
          <h2>AI interpretation helper</h2>
          <div class="toolbar">
            <button id="copyAiPrompt" class="btn primary">Copy prompt</button>
            <button id="downloadAiPrompt" class="btn ghost">Download prompt (txt)</button>
          </div>
        </div>

        <p class="small muted">
          This tool does not make decisions. It prepares a structured prompt you can paste into Copilot, ChatGPT, or any other model
          to generate a plain-English interpretation, explain indicators, highlight trade-offs, and suggest practical improvement levers
          for underperforming treatments.
        </p>

        <label for="aiPromptPreview">Prompt preview <span class="tip" data-tip="This is what will be copied when you click Copy prompt.">?</span></label>
        <textarea id="aiPromptPreview" class="mono" rows="18" readonly></textarea>

        <details class="details">
          <summary>Optional: paste an AI-generated brief here and export</summary>
          <div class="row-2" style="margin-top:10px">
            <div class="field">
              <label for="aiBrief">AI brief text</label>
              <textarea id="aiBrief" rows="12"></textarea>
            </div>
            <div class="field">
              <p class="small muted">Export options for what you paste:</p>
              <div class="toolbar">
                <button id="downloadBriefWord" class="btn">Download as Word (.doc)</button>
                <button id="printBriefPdf" class="btn ghost">Print / PDF</button>
              </div>
              <p class="small muted">
                The Word export is a clean, printable document. You control the content by pasting the brief.
              </p>
            </div>
          </div>
        </details>
      </div>
    </section>

    <!-- APPENDIX TAB -->
    <section class="tab-panel" id="tab-appendix" data-tab-panel="appendix" aria-hidden="true">
      <div class="card">
        <h2>Technical appendix</h2>
        <p class="small muted">
          The appendix documents the indicators, formulas, and the Excel template structure.
        </p>
        <div class="row-2">
          <div class="field">
            <button type="button" class="btn primary"
              onclick="window.open('technical-appendix.html','_blank','noopener');">
              Open technical appendix
            </button>
          </div>
          <div class="field">
            <a href="technical-appendix.html" target="_blank" rel="noopener" class="small">Open technical-appendix.html in a new tab</a>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="app-footer">
    <div class="footer-left">
      <span class="small muted">Farming CBA Decision Tool 2, Newcastle Business School</span>
    </div>
    <div class="footer-right">
      <button id="exportExcelFoot" class="btn small">Export Excel</button>
      <button id="exportPdfFoot" class="btn small ghost">Print or PDF</button>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="app.js"></script>
</body>
</html>
