<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Farming CBA Tool ‚Äî Newcastle Business School</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <!-- SheetJS for Excel import/export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="brand-mark">üöú</div>
      <div class="brand-copy">
        <div class="title">Farming CBA Tool</div>
        <div class="sub">Newcastle Business School ‚Ä¢ The University of Newcastle</div>
      </div>
    </div>
    <div class="contact">
      <a class="chip" href="mailto:frank.agbola@newcastle.edu.au" title="Email">
        üåæ frank.agbola@newcastle.edu.au
      </a>
      <button id="startBtn" class="primary">Start</button>
    </div>
  </header>

  <nav id="tabs" class="tabs">
    <button data-tab="cover" class="active">Cover</button>
    <button data-tab="project">Project</button>
    <button data-tab="time">Time</button>
    <button data-tab="outputs">Outputs</button>
    <button data-tab="treatments">Treatments</button>
    <button data-tab="benefits">Benefits</button>
    <button data-tab="costs">Costs</button>
    <button data-tab="database">Database</button>
    <button data-tab="load">Load</button>
    <button data-tab="distribution">Simulation</button>
    <button data-tab="report">Report</button>
    <button data-tab="help">How to Use</button>
  </nav>

  <!-- COVER -->
  <section id="tab-cover" class="tab-panel show">
    <div class="panel cover-panel">
      <div class="cover-hero">
        <div class="emoji-logo">üåæ</div>
        <div class="emoji-logo">üöú</div>
        <div class="emoji-logo">üå±</div>
        <div class="emoji-logo">üå§Ô∏è</div>
        <div class="emoji-logo">üìà</div>
      </div>
      <h1 class="cover-title">Farming Cost‚ÄìBenefit Analysis (CBA) Tool</h1>
      <p class="cover-subtitle">
        A practical, transparent benefit‚Äìcost framework for farm trials and adoption decisions.
      </p>

      <div class="grid-2">
        <div class="callout">
          <div class="title">About</div>
          <p>
            This tool structures your CBA across <b>Outputs</b> (e.g., Yield, Protein), <b>Treatments</b>,
            <b>Benefits</b> beyond yield, <b>Costs</b>, and <b>Risk & Adoption</b>, to compute indicators like NPV, BCR, IRR, ROI, and Payback.
          </p>
          <p class="muted">
            Logos shown as emojis: üåæüöúüå±üå§Ô∏èüìà (no official UON logo used).
          </p>
        </div>
        <div class="callout">
          <div class="title">Get Started</div>
          <ol class="help-steps">
            <li>Click <b>Start</b> or open the <b>Project</b> tab.</li>
            <li>Define <b>Outputs</b> and add <b>Treatments</b> with delta impacts.</li>
            <li>Add other <b>Benefits</b> (risk reduction, savings) and <b>Costs</b>.</li>
            <li>Use <b>Load</b> to import Excel using the template.</li>
            <li>View results in <b>Report</b> and run <b>Simulation</b>.</li>
          </ol>
          <div class="toolbar">
            <button data-tab-jump="project" class="primary">Start now</button>
            <button data-tab-jump="load" class="ghost">Import Excel</button>
          </div>
        </div>
      </div>

      <div class="grid-3 cover-badges">
        <div class="badge">
          <span>üåæ</span> Outputs: Yield, Protein, Moisture, Biomass
        </div>
        <div class="badge">
          <span>üöú</span> Treatments: up to 15 practices
        </div>
        <div class="badge">
          <span>üìö</span> Sources: Farm Trials, Plant Farm, ABARES, GRDC, Direct
        </div>
        <div class="badge">
          <span>üìà</span> Indicators: NPV, BCR, IRR, ROI, Payback
        </div>
        <div class="badge">
          <span>üßÆ</span> Monte Carlo: discount, adoption, risk
        </div>
        <div class="badge">
          <span>üì§</span> Export: CSV / Print to PDF
        </div>
      </div>

      <div class="muted small">
        ¬© Newcastle Business School ‚Äî Demo tool. Contact:
        <a href="mailto:frank.agbola@newcastle.edu.au">frank.agbola@newcastle.edu.au</a>
      </div>
    </div>
  </section>

  <!-- PROJECT -->
  <section id="tab-project" class="tab-panel">
    <div class="panel">
      <h2>Project setup</h2>
      <div class="grid-2">
        <div class="field">
          <label>Project name</label>
          <input id="projectName" />
        </div>
        <div class="field">
          <label>Analyst(s)</label>
          <input id="analystNames" />
        </div>
        <div class="field">
          <label>Organisation</label>
          <input id="organisation" placeholder="Newcastle Business School, The University of Newcastle" />
        </div>
        <div class="field">
          <label>Contact email</label>
          <input id="contactEmail" placeholder="frank.agbola@newcastle.edu.au" />
        </div>
        <div class="field">
          <label>Last updated (YYYY-MM-DD)</label>
          <input id="lastUpdated" />
        </div>
      </div>

      <div class="field">
        <label>Project summary</label>
        <textarea id="projectSummary" rows="2"></textarea>
      </div>

      <div class="field">
        <label>Goal or target</label>
        <textarea id="projectGoal" rows="2"></textarea>
      </div>

      <div class="grid-2">
        <div class="field">
          <label>With-project scenario</label>
          <textarea id="withProject" rows="4"></textarea>
        </div>
        <div class="field">
          <label>Without-project scenario</label>
          <textarea id="withoutProject" rows="4"></textarea>
        </div>
      </div>

      <div class="toolbar">
        <button id="saveProject" class="ghost">Save as JSON</button>
        <button id="loadProject" class="ghost">Load JSON</button>
        <input type="file" id="loadFile" accept=".json" hidden />
        <span class="spacer"></span>
        <button data-tab-jump="time" class="primary">Next: Time</button>
      </div>
    </div>
  </section>

  <!-- TIME -->
  <section id="tab-time" class="tab-panel">
    <div class="panel">
      <h2>Time & discounting</h2>
      <div class="grid-3">
        <div class="field">
          <label>Start year</label>
          <input id="startYear" type="number" />
        </div>
        <div class="field">
          <label>Analysis horizon (years)</label>
          <input id="years" type="number" min="1" max="50" />
        </div>
        <div class="field">
          <label>Discount (base, %)</label>
          <input id="discBase" type="number" step="0.1" />
        </div>
        <div class="field">
          <label>Discount (low, %)</label>
          <input id="discLow" type="number" step="0.1" />
        </div>
        <div class="field">
          <label>Discount (high, %)</label>
          <input id="discHigh" type="number" step="0.1" />
        </div>
        <div class="field">
          <label>MIRR finance rate (%)</label>
          <input id="mirrFinance" type="number" step="0.1" />
        </div>
        <div class="field">
          <label>MIRR reinvest rate (%)</label>
          <input id="mirrReinvest" type="number" step="0.1" />
        </div>
      </div>

      <h3>Adoption</h3>
      <div class="grid-3">
        <div class="field"><label>Adoption (low)</label><input id="adoptLow" type="number" step="0.01" /></div>
        <div class="field"><label>Adoption (base)</label><input id="adoptBase" type="number" step="0.01" /></div>
        <div class="field"><label>Adoption (high)</label><input id="adoptHigh" type="number" step="0.01" /></div>
      </div>

      <h3>Risk of project failure</h3>
      <div class="grid-3">
        <div class="field"><label>Risk (low)</label><input id="riskLow" type="number" step="0.01" /></div>
        <div class="field"><label>Risk (base)</label><input id="riskBase" type="number" step="0.01" /></div>
        <div class="field"><label>Risk (high)</label><input id="riskHigh" type="number" step="0.01" /></div>
      </div>
      <div class="grid-5">
        <div class="field"><label>Technical</label><input id="rTech" type="number" step="0.01" /></div>
        <div class="field"><label>Non-cooperation</label><input id="rNonCoop" type="number" step="0.01" /></div>
        <div class="field"><label>Socio-political</label><input id="rSocio" type="number" step="0.01" /></div>
        <div class="field"><label>Financial</label><input id="rFin" type="number" step="0.01" /></div>
        <div class="field"><label>Managerial</label><input id="rMan" type="number" step="0.01" /></div>
      </div>
      <button id="calcCombinedRisk" class="ghost">Combine factors ‚Üí</button>
      <span id="combinedRiskOut" class="muted"></span>

      <div class="toolbar">
        <button data-tab-jump="outputs" class="primary">Next: Outputs</button>
      </div>
    </div>
  </section>

  <!-- OUTPUTS -->
  <section id="tab-outputs" class="tab-panel">
    <div class="panel">
      <h2>Valued outputs ($/unit)</h2>
      <div id="outputsList" class="stack"></div>
      <button id="addOutput" class="ghost">Add output</button>

      <div class="toolbar">
        <button data-tab-jump="treatments" class="primary">Next: Treatments</button>
      </div>
    </div>
  </section>

  <!-- TREATMENTS -->
  <section id="tab-treatments" class="tab-panel">
    <div class="panel">
      <h2>Treatments (practices)</h2>
      <div id="treatmentsList" class="stack"></div>
      <button id="addTreatment" class="ghost">Add treatment</button>

      <div class="toolbar">
        <button data-tab-jump="benefits" class="primary">Next: Benefits</button>
      </div>
    </div>
  </section>

  <!-- BENEFITS -->
  <section id="tab-benefits" class="tab-panel">
    <div class="panel">
      <h2>Benefits (beyond treatment √ó output effects)</h2>

      <div class="explain">
        <h3>How the tool calculates benefits</h3>
        <ul>
          <li><b>Treatment benefits</b> = Œ£ over treatments [ (Œ£ over outputs (Œî<sub>output</sub> √ó $/unit)) √ó area √ó adoption √ó (1 ‚àí risk) ].</li>
          <li><b>Additional benefits</b> (this tab) add non-yield effects (e.g., cost savings, risk reduction, asset improvements). Each item creates a cashflow from start to end year, optionally linking to adoption and/or overall risk.</li>
        </ul>
        <div class="note">
          Categories supported:
          <ol>
            <li><b>C1</b> Benefit per person/household</li>
            <li><b>C2</b> Benefit per user unit</li>
            <li><b>C3</b> Benefit per abatement unit</li>
            <li><b>C4</b> Aggregate per year ($/yr)</li>
            <li><b>C5</b> Delay/reduction in cost</li>
            <li><b>C6</b> Improved asset value (once-off)</li>
            <li><b>C7</b> Reduced consequence of risky event</li>
            <li><b>C8</b> Custom (annual or once-off)</li>
          </ol>
        </div>
      </div>

      <div id="benefitsList" class="stack"></div>
      <button id="addBenefit" class="ghost">Add benefit item</button>

      <div class="toolbar">
        <button data-action="recalc" class="primary">Recalculate</button>
        <span class="muted">Totals update in the Report.</span>
      </div>
    </div>
  </section>

  <!-- COSTS -->
  <section id="tab-costs" class="tab-panel">
    <div class="panel">
      <h2>Other costs</h2>
      <div id="costsList" class="stack"></div>
      <button id="addCost" class="ghost">Add cost item</button>

      <div class="toolbar">
        <button data-tab-jump="database" class="primary">Next: Database</button>
      </div>
    </div>
  </section>

  <!-- DATABASE -->
  <section id="tab-database" class="tab-panel">
    <div class="panel">
      <h2>Database/source tags</h2>
      <h3>Outputs</h3>
      <div id="dbOutputs" class="stack"></div>
      <h3>Treatments</h3>
      <div id="dbTreatments" class="stack"></div>

      <div class="toolbar">
        <button data-tab-jump="load" class="primary">Next: Load/Excel</button>
      </div>
    </div>
  </section>

  <!-- LOAD -->
  <section id="tab-load" class="tab-panel">
    <div class="panel">
      <h2>Load / Excel</h2>
      <div class="grid-2">
        <div class="field">
          <label>Excel/CSV file</label>
          <input id="excelFile" type="file" accept=".xlsx,.xls,.csv" />
          <div class="muted">For CSV, choose target sheet name:</div>
          <select id="csvSheetType">
            <option>Outputs</option>
            <option>Treatments</option>
            <option>OtherCosts</option>
            <option>Time</option>
            <option>AdoptionRisk</option>
            <option>Project</option>
            <option>Benefits</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="toolbar">
            <button id="parseExcel" class="ghost">Parse file</button>
            <button id="importExcel" class="primary" disabled>Import to Tool</button>
          </div>
          <div id="loadStatus" class="muted"></div>
        </div>
      </div>

      <div class="callout warn" id="validation"></div>
      <div id="preview"></div>

      <div class="toolbar">
        <button id="downloadTemplate" class="ghost">Download Excel Template</button>
        <button id="downloadSample" class="ghost">Download Sample Dataset</button>
      </div>

      <div class="callout">
        <h3>Excel structure</h3>
        <p>Create sheets named: <b>Project</b>, <b>Time</b>, <b>Outputs</b>, <b>Treatments</b>, <b>OtherCosts</b>, <b>AdoptionRisk</b>, <b>Benefits</b>.</p>
        <ul>
          <li><b>Outputs</b>: Name, Unit, ValuePerUnit, Source</li>
          <li><b>Treatments</b>: Name, Area, Adoption, AnnualCostPerHa, CapitalCostY0, Constrained, Source, Delta:Yield, Delta:Protein, Delta:Moisture, Delta:Biomass ‚Ä¶</li>
          <li><b>OtherCosts</b>: Label, Type (Annual/Capital), Annual, StartYear, EndYear, Capital, Year, Constrained</li>
          <li><b>Time</b>: StartYear, Years, DiscLow, DiscBase, DiscHigh, MIRR_Finance, MIRR_Reinvest</li>
          <li><b>AdoptionRisk</b>: AdoptLow, AdoptBase, AdoptHigh, RiskLow, RiskBase, RiskHigh, Tech, NonCoop, Socio, Fin, Man</li>
          <li><b>Project</b>: Name, Analysts, Organisation, ContactEmail, Summary, Goal, WithProject, WithoutProject, LastUpdated</li>
          <li><b>Benefits</b>: Label, Category (C1..C8), Frequency (Annual/Once), StartYear, EndYear, Year, UnitValue, Quantity, Abatement, AnnualAmount, GrowthPct, LinkAdoption (Yes/No), LinkRisk (Yes/No), P0, P1, Consequence, Notes</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- SIMULATION -->
  <section id="tab-distribution" class="tab-panel">
    <div class="panel">
      <h2>Monte Carlo</h2>
      <div class="grid-4">
        <div class="field"><label>Runs (N)</label><input id="simN" type="number" value="1000" /></div>
        <div class="field">
          <label>BCR mode</label>
          <select id="bcrMode">
            <option value="all">Unconstrained (all costs)</option>
            <option value="constrained">Constrained budget</option>
          </select>
        </div>
        <div class="field"><label>BCR target</label><input id="targetBCR" type="number" step="0.1" /></div>
        <div class="field"><label>Seed (optional)</label><input id="randSeed" type="number" /></div>
      </div>
      <button id="runSim" data-action="run-sim" class="primary">Run</button>
      <span id="simStatus" class="muted"></span>

      <div class="grid-2">
        <div class="card">
          <h3>NPV</h3>
          <canvas id="histNpv" width="520" height="280"></canvas>
          <div class="stats">
            <div>Min: <span id="simNpvMin">‚Äî</span></div>
            <div>Max: <span id="simNpvMax">‚Äî</span></div>
            <div>Mean: <span id="simNpvMean">‚Äî</span></div>
            <div>Median: <span id="simNpvMedian">‚Äî</span></div>
            <div>Pr(NPV &gt; 0): <span id="simNpvProb">‚Äî</span></div>
          </div>
        </div>
        <div class="card">
          <h3>BCR <small>(target: <span id="simBcrTargetLabel">2</span>)</small></h3>
          <canvas id="histBcr" width="520" height="280"></canvas>
          <div class="stats">
            <div>Min: <span id="simBcrMin">‚Äî</span></div>
            <div>Max: <span id="simBcrMax">‚Äî</span></div>
            <div>Mean: <span id="simBcrMean">‚Äî</span></div>
            <div>Median: <span id="simBcrMedian">‚Äî</span></div>
            <div>Pr(BCR &gt; 1): <span id="simBcrProb1">‚Äî</span></div>
            <div>Pr(BCR &gt; target): <span id="simBcrProbTarget">‚Äî</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- REPORT -->
  <section id="tab-report" class="tab-panel">
    <div class="panel">
      <h2>Report</h2>
      <div class="grid-4 kpis">
        <div class="metric"><label>PV Benefits</label><div id="pvBenefits" class="value">‚Äî</div></div>
        <div class="metric"><label>PV Costs</label><div id="pvCosts" class="value">‚Äî</div></div>
        <div class="metric"><label>NPV</label><div id="npv" class="value">‚Äî</div></div>
        <div class="metric"><label>BCR</label><div id="bcr" class="value">‚Äî</div></div>
        <div class="metric"><label>IRR</label><div id="irr" class="value">‚Äî</div></div>
        <div class="metric"><label>MIRR</label><div id="mirr" class="value">‚Äî</div></div>
        <div class="metric"><label>ROI</label><div id="roi" class="value">‚Äî</div></div>
        <div class="metric"><label>Payback (yrs)</label><div id="payback" class="value">‚Äî</div></div>
        <div class="metric"><label>Gross Margin (annual)</label><div id="grossMargin" class="value">‚Äî</div></div>
        <div class="metric"><label>Gross Profit Margin</label><div id="profitMargin" class="value">‚Äî</div></div>
      </div>

      <h3>Treatment summary</h3>
      <div id="treatmentSummary" class="stack"></div>

      <div class="toolbar">
        <button id="recalc" class="ghost">Recalculate</button>
        <span class="spacer"></span>
        <button id="exportCsv" class="ghost">Export CSV</button>
        <button id="exportPdf" class="ghost">Print / PDF</button>
      </div>
      <div class="toolbar">
        <button id="exportCsvFoot" class="ghost">Export CSV</button>
        <button id="exportPdfFoot" class="ghost">Print / PDF</button>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section id="tab-help" class="tab-panel">
    <div class="panel">
      <h2>How to use the tool (plain language)</h2>
      <ol class="help-steps">
        <li><b>Project</b>: describe the project, set contact and summary.</li>
        <li><b>Time</b>: set analysis years and discount rates. Enter adoption and risk ranges.</li>
        <li><b>Outputs</b>: define the outputs you value (e.g., Yield $/t, Protein $ per %-point).</li>
        <li><b>Treatments</b>: add practices, areas (ha), adoption, costs, and ‚Äúdelta‚Äù impacts on each output.</li>
        <li><b>Benefits</b>: add extra non-yield benefits (e.g., cost savings, risk reduction). These stack onto treatment benefits.</li>
        <li><b>Costs</b>: add other project costs (management, monitoring, etc.).</li>
        <li><b>Database</b>: tag sources for transparency (Farm Trials, ABARES, GRDC, etc.).</li>
        <li><b>Load</b>: import from Excel/CSV using the provided template. You can also download a sample dataset.</li>
        <li><b>Simulation</b>: run Monte Carlo to view uncertainty for NPV and BCR.</li>
        <li><b>Report</b>: view results and export as CSV/PDF.</li>
      </ol>
      <p class="muted">Questions? Contact <a href="mailto:frank.agbola@newcastle.edu.au">frank.agbola@newcastle.edu.au</a>.</p>
    </div>
  </section>

  <footer class="app-footer">
    <div>¬© Newcastle Business School ‚Äî Farming CBA Tool</div>
    <div>Contact: <a href="mailto:frank.agbola@newcastle.edu.au">frank.agbola@newcastle.edu.au</a></div>
  </footer>

  <script src="app.js"></script>
</body>
</html>
